---
title: çº¿ä¸Šæ•…éšœæ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä»‹ç»
author: baixiaozhou
categories:
  - é—®é¢˜æ’æŸ¥
tags:
  - Linux
  - Java
  - Golang
  - commands
description: çº¿ä¸Šæ•…éšœé—®é¢˜çš„æ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä»‹ç»ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€è´Ÿè½½ã€ç£ç›˜ã€IOã€ç½‘ç»œç­‰
date: 2024-08-15 11:12:21
references:
  - '[Examining Load Average](https://www.linuxjournal.com/article/9001)'
  - '[What-is-CPU-Load-Average](https://community.tenable.com/s/article/What-is-CPU-Load-Average)'
cover: /images/server.jpg
banner: /images/server.jpg
---

<!-- more -->

- [å†™åœ¨å‰é¢](#å†™åœ¨å‰é¢)
- [CPUä½¿ç”¨ç‡é£™å‡](#cpuä½¿ç”¨ç‡é£™å‡)
  - [å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡](#å¦‚ä½•è®©cpuä½¿ç”¨ç‡é£™å‡)
  - [å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡](#å¦‚ä½•åˆ¤æ–­å’Œå‘ç°cpuä½¿ç”¨ç‡é£™å‡)
  - [å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº](#å¦‚ä½•ç¡®å®šcpué£™å‡çš„æ ¹æº)
    - [perfå‘½ä»¤](#perfå‘½ä»¤)
    - [jstack](#jstack)
    - [ç«ç„°å›¾](#ç«ç„°å›¾)
- [è´Ÿè½½é£™å‡](#è´Ÿè½½é£™å‡)
  - [è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½](#è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½)
  - [CPUçš„ä½¿ç”¨æƒ…å†µ VS loadavg](#cpuçš„ä½¿ç”¨æƒ…å†µ-vs-loadavg)


## å†™åœ¨å‰é¢

åœ¨å¾ˆå¤šæ–‡ç« ä¸­ï¼Œæ¯å½“æåˆ°å»è§£å†³çº¿ä¸Šé—®é¢˜çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†çš„å¤„ç†æ–¹å¼å°±æ˜¯ç™»å½•ç¯å¢ƒï¼Œå“å“å„ç§æ•²å‘½ä»¤ã€‚æ“ä½œæœ¬èº«æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šäººè€Œè¨€ï¼Œæˆ‘è§‰å¾—è¿™ç§åšæ³•å…¶å®æ˜¯æœ¬æœ«å€’ç½®çš„ï¼Œè¿‡äºåœ¨ä¹å»å¿«é€ŸæŠ“ä½é‡ç‚¹é—®é¢˜ï¼Œè€Œå¿½ç•¥äº†ä»å…¨å±€å»çœ‹é—®é¢˜ã€‚é‚£ä¹ˆå¦‚æœæœ€å¼€å§‹ä¸å»æ“ä½œå„ç§å‘½ä»¤ï¼Œé‚£åº”è¯¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿ

***çœ‹ç›‘æ§ï¼ï¼ï¼ï¼***

é¦–å…ˆä¸è¦è§‰å¾—è¿™ä¸ªæ˜¯åºŸè¯ï¼Œå¯¹äºå¾ˆå¤šåœºæ™¯æ¥è¯´ï¼Œä¸šåŠ¡è§„æ¨¡æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œæœ‰çš„æ—¶å€™å¹¶å‘è¶…è¿‡äº†æé™çš„æ€§èƒ½ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹éƒ½æ²¡æœ‰å¿…è¦å»åå°è¿›è¡Œå„ç§æŸ¥è¯¢ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡å¦‚è¯´æŸå¥—ä¸šåŠ¡ç³»ç»Ÿï¼Œæœ¬èº«åªèƒ½æ”¯æŒ 500 å¹¶å‘ï¼Œç°åœ¨å®é™…ä¸Šçš„é‡åˆ°äº† 2000ï¼Œå¯¼è‡´çº¿ä¸Šå„ç§å†…å­˜ã€CPUã€è´Ÿè½½çš„å‘Šè­¦ï¼Œè¿™ç§æƒ…å†µä¸‹è¿˜æœ‰å¿…è¦å»åå°æ•²`top`ã€`free`å—ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯å¦å®šçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦è€ƒè™‘å¯¹ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œå¿«é€Ÿçš„æ‰©å®¹ç­‰ã€‚

çœ‹ç›‘æ§çš„æ„ä¹‰åœ¨äºå°½å¯èƒ½çš„æ‰¾åˆ°æ›´å¤šçš„æ€§èƒ½ç“¶é¢ˆæˆ–è€…å¼‚å¸¸çš„ç‚¹ï¼Œä»å…¨å±€å‡ºå‘ï¼Œå¯¹ç³»ç»Ÿå½“å‰å­˜åœ¨çš„é—®é¢˜å’Œå¼‚å¸¸ç‚¹æœ‰å…¨é¢çš„äº†è§£ã€‚

ç›‘æ§ç³»ç»Ÿå¤šç§å¤šæ ·ï¼Œä»è¾ƒæ—©çš„ zabbix åˆ°ç°åœ¨æ¯”è¾ƒæµè¡Œçš„prometheus+grafanaï¼ˆä¸¾ä¸¤ä¸ªå¸¸ç”¨çš„ä¾‹å­ï¼‰ï¼Œå¯¹äºç³»ç»Ÿä¸šåŠ¡éƒ½æœ‰æ¯”è¾ƒå®Œå–„çš„ç›‘æ§ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ å…·ä½“çš„äº†è§£åˆ°ç³»ç»Ÿè¿è¡Œå…¨è²Œã€‚å¦‚æœä½ å¯¹è¿™äº›éƒ½ä¸å–œæ¬¢ï¼Œé‚£ä¹ˆä½ è‡ªå·±å†™ä¸€ä¸ªç›‘æ§ç³»ç»Ÿä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚

å½“æˆ‘ä»¬çœ‹å®Œç›‘æ§ä¹‹åï¼ˆå‡è®¾ä½ çœŸçš„çœ‹äº†ï¼‰ï¼Œæ¥ä¸‹æ¥è¿›å…¥å®é™…æ“ä½œç¯èŠ‚ï¼Œæˆ‘ä¼šä»è¿™äº›æŒ‡æ ‡çš„è¯¦ç»†å«ä¹‰å‡ºå‘ï¼Œç„¶åå°½å¯èƒ½åœ°å°†å„ç§å¤„ç†æ–¹å¼åˆ†äº«ç»™å¤§å®¶ã€‚

## CPUä½¿ç”¨ç‡é£™å‡

### å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡

è¿™ä¸ªé—®é¢˜å…¶å®å¾ˆç®€å•ï¼Œåªè¦æœ‰è®¡ç®—ä»»åŠ¡ä¸€ç›´å­˜åœ¨ï¼Œè®© CPU ä¸€ç›´å¤„äºç¹å¿™ä¹‹ä¸­ï¼Œé‚£ä¹ˆ CPU å¿…ç„¶é£™å‡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ç³»åˆ—çš„å·¥å…·å»æ¨¡æ‹Ÿè¿™ä¸ªæƒ…å†µã€‚

[github SysStress](https://github.com/baixiaozhou/SysStress) è¿™æ˜¯æˆ‘è‡ªå·±ç”¨ golang å†™çš„å‹æµ‹å·¥å…·(è¿˜åœ¨å¼€å‘ä¸­ï¼Œå¯ä»¥ç‚¹ä¸ª star è®©æˆ‘æ›´æœ‰åŠ¨åŠ›ğŸ˜‚)

ä½¿ç”¨æ–¹æ³•:
```
./sysstress cpu --cpu-number 10 --duration 10m
```
è¿™ä¸ªå°±æ˜¯æ¨¡æ‹Ÿå ç”¨ 10 æ ¸å¿ƒçš„ CPU å¹¶æŒç»­ 10minï¼Œå½“ç„¶å¤§å®¶ä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„å‹æµ‹å·¥å…·ï¼Œæ¯”å¦‚`stress-ng`

### å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼Œè·Ÿ CPU ä½¿ç”¨ç‡ç›¸å…³çš„æœ‰å“ªäº›æŒ‡æ ‡ã€‚æˆ‘ä»¬é€šè¿‡ `top` å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°å…·ä½“çš„ä¿¡æ¯

![top](../images/top.png)
è¿™äº›è¾“å‡ºä¸­æœ‰ä¸€è¡Œæ˜¯ `%Cpu(s)`, è¿™è¡Œå±•ç¤ºäº† CPU çš„æ•´ä½“ä½¿ç”¨æƒ…å†µï¼Œæ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”çš„å½¢å¼ï¼Œæˆ‘ä»¬è¯¦ç»†é˜è¿°ä¸‹è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰
```
us, user    : time running un-niced user processes   æœªé™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´
sy, system  : time running kernel processes          å†…æ ¸è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´
ni, nice    : time running niced user processes      é™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´
id, idle    : time spent in the kernel idle handler  ç©ºé—²çš„æ—¶é—´
wa, IO-wait : time waiting for I/O completion        ç­‰å¾… I/O æ“ä½œå®Œæˆæ‰€èŠ±è´¹çš„æ—¶é—´
hi : time spent servicing hardware interrupts        å¤„ç†ç¡¬ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´
si : time spent servicing software interrupts        å¤„ç†è½¯ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´
st : time stolen from this vm by the hypervisor      è¢«è™šæ‹Ÿæœºç®¡ç†ç¨‹åºä»æ­¤è™šæ‹Ÿæœºä¸­çªƒå–çš„æ—¶é—´
```
åœ¨è¿™äº›æŒ‡æ ‡ä¸­ï¼Œä¸€èˆ¬å…³æ³¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯ usã€syã€idã€waï¼ˆå…¶ä»–å‡ ä¸ªæŒ‡æ ‡å¾ˆé«˜çš„æƒ…å†µæˆ‘ä¸ªäººç›®å‰åŸºæœ¬ä¸Šæ²¡æœ‰é‡åˆ°è¿‡ï¼‰

ä¸Šè¿°æŒ‡æ ‡åæ˜ äº†ç³»ç»Ÿæ•´ä½“çš„ CPU æƒ…å†µã€‚è€Œç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­å®é™…ä¸Šæ˜¯ä»¥ä¸€ä¸ªä¸ªçš„è¿›ç¨‹å­˜åœ¨çš„ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•ç¡®å®šåˆ°å ç”¨ CPU é«˜çš„è¿›ç¨‹å‘¢ï¼Ÿè®©æˆ‘ä»¬çš„ç›®å…‰ä» top çš„å¤´éƒ¨ä¿¡æ¯å¾€ä¸‹ç§»åŠ¨ï¼Œä¸‹é¢å°±å±•ç¤ºäº†è¯¦ç»†çš„è¿›ç¨‹ä¿¡æ¯
![top-process](../images/top-process.png)

è¿™äº›ç¨‹åºé»˜è®¤æ˜¯æŒ‰ç…§ CPU çš„ä½¿ç”¨ç‡ä»é«˜åˆ°åº•è¿›è¡Œæ’åºçš„ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡åœ¨`top`çš„æ—¶å€™è¾“å…¥`P`è¿›è¡Œæ’åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­æ¶ˆè€— CPU èµ„æºçš„è¯¦ç»†è¿›ç¨‹ä¿¡æ¯

ä¸Šé¢æ˜¯æˆ‘é€šè¿‡ `./sysstress cpu --cpu-number 10 --duration 10m` å‹æµ‹ç¨‹åºè·‘å‡ºæ¥çš„ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ sysstress ç¨‹åºå ç”¨äº† 1002 çš„ %CPUï¼Œä¹Ÿå°±æ˜¯è¯´åŸºæœ¬ä¸Šæ˜¯ 10 ä¸ªæ ¸å¿ƒï¼Œé‚£æˆ‘ä»¬è·‘ä¸€ä¸ªæ›´é«˜çš„ï¼Œå°†`--cpu-number`åŠ åˆ° 60 çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ
![stress-cpu](../images/stress-cpu.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ¬¡%CPUæ‰“åˆ°äº† 6000ï¼Œé‚£å¾ˆå¤šäººå°±å¥½å¥‡æˆ‘æ—¥å¸¸çš„ç¨‹åºè·‘åˆ°å¤šé«˜ç®—é«˜å‘¢ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼Œç°åœ¨çš„æœåŠ¡å™¨ç»å¤§éƒ¨åˆ†éƒ½æ˜¯å¤šæ ¸å¿ƒ CPUï¼ˆ1C2Gè¿™ç§è‡ªå·±ç”¨æ¥ç©çš„å¿½ç•¥ï¼‰ï¼ŒCPU çš„æ ¸å¿ƒæ•°å†³å®šäº†æˆ‘ä»¬ç¨‹åºåœ¨åŒä¸€æ—¶é—´èƒ½å¤Ÿæ‰§è¡Œå¤šå°‘ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªé«˜ä¸é«˜æ˜¯ç›¸å¯¹äºæœºå™¨é…ç½®è€Œè¨€çš„ã€‚å¦‚æœä½ çš„æœºå™¨åªæœ‰ 16Cï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 1000ï¼Œé‚£ä¹ˆå…¶å®å·²ç»ç®—æ˜¯æ¯”è¾ƒé«˜äº†ã€‚å¦‚æœæ˜¯ 256C çš„CPUï¼ˆåœŸè±ªçº§é…ç½®ï¼‰ï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 6000ï¼Œå¯¹äºç³»ç»Ÿçš„ç¨³å®šæ€§å½±å“å°±æ²¡æœ‰é‚£ä¹ˆå¤§äº†ã€‚

ä¸Šè¿°æˆ‘ä»¬è¯´çš„æƒ…å†µæ˜¯è¿›ç¨‹å ç”¨ CPU å¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ï¼Œé‚£ä¹ˆè¿›ç¨‹å ç”¨çš„ CPU å¯¹ç³»ç»Ÿçš„å½±å“ä¸å¤§å°±ä»£è¡¨è¿™ä¸ªç¨‹åºä¸€å®šæ²¡æœ‰é—®é¢˜å—ï¼Ÿç­”æ¡ˆæ˜¾ç„¶æ˜¯æœªå¿…çš„ã€‚

æˆ‘ä»¬è¿˜æ˜¯è¦å›å½’åˆ°ä¸šåŠ¡æœ¬èº«ï¼Œå¦‚æœè¿›ç¨‹çš„ CPU å ç”¨åœ¨ä¸šåŠ¡å˜åŠ¨ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œå‘ç”Ÿäº†å¼‚å¸¸æ³¢åŠ¨ï¼Œæˆ–è€…æ­£å¸¸æƒ…å†µä¸‹ä¸šåŠ¡ä¸ä¼šæ¶ˆè€—è¿™ä¹ˆé«˜çš„ CPUï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç»§ç»­æ’æŸ¥äº†ã€‚

### å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº
è¿™ä¸ªé—®é¢˜çš„ æ ¸å¿ƒæ˜¯ CPU ä¸Šåœ¨è¿è¡Œä»€ä¹ˆä¸œè¥¿ã€‚ å¤šæ ¸å¿ƒCPU ä¸‹ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½å¯ä»¥æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šä¸€ä¸ªè¿›ç¨‹ä¸­é‚£äº›æ–¹æ³•åœ¨æ¶ˆè€— CPU å‘¢ï¼Ÿä»è€Œå¼•ç”³ä¸‹é¢è¯¦ç»†çš„é—®é¢˜:
 1. ç¨‹åºçš„è°ƒç”¨æ ˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ
 2. è°ƒç”¨æ ˆä¿¡æ¯ä¸­å“ªäº›æ˜¯éœ€è¦å…³æ³¨çš„ï¼Œé‚£äº›æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Ÿ
 3. çƒ­ç‚¹å‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿ

è€è¯è¯´å¾—å¥½ï¼Œ"å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨", æˆ‘ä»¬éœ€è¦è¿™äº›ä¸œè¥¿ï¼Œå°±å¿…é¡»äº†è§£åˆ°ä»€ä¹ˆæ ·çš„å·¥å…·å¯ä»¥æ‹¿åˆ°ä¸Šé¢æˆ‘æåˆ°çš„ä¸€äº›ä¿¡æ¯ã€‚æ¥ä¸‹æ¥æˆ‘å°†é€šè¿‡å¸¸ç”¨çš„åç«¯è¯­è¨€ï¼š`golang` å’Œ `java` ä¸ºä¾‹æ„é€ ä¸€äº›é«˜ CPU çš„ç¨‹åºæ¥è¿›è¡Œå±•ç¤ºã€‚

#### perfå‘½ä»¤
**perfæ˜¯ä¸€æ¬¾Linuxæ€§èƒ½åˆ†æå·¥å…·ã€‚Linuxæ€§èƒ½è®¡æ•°å™¨æ˜¯ä¸€ä¸ªæ–°çš„åŸºäºå†…æ ¸çš„å­ç³»ç»Ÿï¼Œå®ƒæä¾›ä¸€ä¸ªæ€§èƒ½åˆ†ææ¡†æ¶ï¼Œæ¯”å¦‚ç¡¬ä»¶ï¼ˆCPUã€PMU(Performance Monitoring Unit)ï¼‰åŠŸèƒ½å’Œè½¯ä»¶(è½¯ä»¶è®¡æ•°å™¨ã€tracepoint)åŠŸèƒ½ã€‚**

å®‰è£…:
```
yum install perf   #Centos
```
å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆçœ‹ä¸‹ `perf`çš„ç”¨æ³•ï¼Œè¿™é‡Œä¸å±•å¼€å…·ä½“ç”¨æ³•ï¼Œåªåˆ—å‡ºæˆ‘å¹³å¸¸ä½¿ç”¨çš„å‡ ä¸ªå‘½ä»¤:
```
top        System profiling tool.               #å¯¹ç³»ç»Ÿæ€§èƒ½è¿›è¡Œå®æ—¶åˆ†æã€‚
record     Run a command and record its profile into perf.data     #æ”¶é›†é‡‡æ ·ä¿¡æ¯
report     Read perf.data (created by perf record) and display the profile  #åˆ†æé‡‡æ ·ä¿¡æ¯ï¼Œå’Œrecordé…åˆä½¿ç”¨
```
record å’Œ report çš„ä½¿ç”¨æ›´å¤šåœ¨äº dump å½“å‰ç¯å¢ƒçš„ä¿¡æ¯ç”¨äºåç»­åˆ†æï¼Œå¦‚æœåœ¨è‡ªå·±ç¯å¢ƒä¸Šæµ‹è¯•ï¼Œå¯ä»¥ç”¨ top è¿›è¡Œä¸€äº›ç®€å•çš„å®æ—¶åˆ†æï¼ˆç±»ä¼¼äº top å‘½ä»¤ï¼‰ã€‚

è¿˜æ˜¯ç”¨ä¹‹å‰çš„å‹æµ‹å·¥å…·ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ª 10 æ ¸å¿ƒçš„ 10min çš„å‹æµ‹åœºæ™¯
```
nohup ./sysstress cpu --cpu-number 10 --duration 10m > /dev/null 2>&1 &
```
æ‰§è¡Œè¿™ä¸ªè¯­å¥ï¼Œè®©å‹æµ‹ç¨‹åºåœ¨åå°æ‰§è¡Œï¼Œç„¶åæˆ‘ä»¬é€šè¿‡`perf top`æŸ¥çœ‹å…·ä½“çš„æƒ…å†µï¼ˆå¯ä»¥é€šè¿‡-p æŒ‡å®š pidï¼‰

![perf top](../images/perftop.png)

ä»æˆªå›¾çš„ä¿¡æ¯ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å ç”¨èµ„æºæœ€å¤šçš„ä¸€äº›æ–¹æ³•ï¼ŒåŒ…æ‹¬ sysstress è¿›ç¨‹çš„å„ç§æ–¹æ³•(ä»å›¾ç‰‡ä¸­åŸºæœ¬ä¸Šå°±å¯ä»¥ç¡®å®šé«˜æ¶ˆè€—çš„æ–¹æ³•åœ¨å“ªé‡Œ)ä»¥åŠåº•å±‚çš„ `__vdso_clock_gettime`, é‚£å†ç»“åˆå‹æµ‹å·¥å…·çš„ä»£ç åˆ†æä¸‹:

``` golang
func burnCpu(wg *sync.WaitGroup, start time.Time, durSec int64) {
	defer wg.Done()
	for {
		_ = 1 * 1
		now := time.Now()
		if now.Sub(start) > time.Duration(durSec)*time.Second {
			break
		}
	}
}
```
è¿™æ˜¯æ–¹æ³•çš„æ ¸å¿ƒï¼Œå…¶å®å°±æ˜¯åšæ— æ„ä¹‰çš„è®¡ç®—ï¼Œå¤–åŠ æ—¶é—´çš„åˆ¤æ–­ï¼Œè¶…è¿‡ duration å°±ç»“æŸã€‚è¿™æ ·å’Œä¸Šé¢çš„ perf top ä¿¡æ¯å°±èƒ½å¯¹åº”èµ·æ¥ã€‚

ç„¶åæˆ‘ä»¬ç”¨ java å†™ä¸€ä¸ªåŒæ ·çš„ç¨‹åºï¼Œå†çœ‹çœ‹ `perf top`çš„æƒ…å†µ:
![perf top](../images/javaperftop.png)
ä»è¿™ä¸€å¤§æ®µæ˜¾ç¤ºæ¥çœ‹ï¼Œæ˜¯ä¸æ˜¯çœ‹çš„ä¸€è„¸æ‡µé€¼ï¼Œå¾ˆéš¾å‘ç°åˆ°åº•æ˜¯ä»€ä¹ˆç¨‹åºåœ¨å ç”¨CPU èµ„æºã€‚å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹æºç¨‹åº:
``` java
import java.time.LocalDateTime;

public class Main {
    public static void main(String[] args) {
        int n = 10;

        for (int i = 0; i < 10; i++) {
            new Thread(new Runnable() {
                public void run() {
                    while (true) {
                        Math.sin(Math.random());
                        LocalDateTime currentTime = LocalDateTime.now();
                    }
                }
            }).start();
        }
    }
}
```
è¿™é‡Œçš„ç¨‹åºä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œå¯åŠ¨ 10 ä¸ªçº¿ç¨‹ï¼Œåšä¸€ä¸ªæ— æ„ä¹‰çš„æ•°å­¦è¿ç®—ï¼Œç„¶åè·å–å½“å‰æ—¶é—´ã€‚ä»è¿™æ®µä»£ç ä¸­æ˜¯ä¸æ˜¯å¾ˆéš¾å’Œä¸Šé¢`perf top`çš„æ˜¾ç¤ºå…³è”èµ·æ¥ï¼Ÿ åŸå› ä¹Ÿéå¸¸ç®€å•ï¼Œ åƒJava è¿™ç§é€šè¿‡ JVM æ¥è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè¿è¡Œå †æ ˆç”¨çš„éƒ½æ˜¯ JVM å†…ç½®çš„å‡½æ•°å’Œå †æ ˆç®¡ç†ã€‚æ‰€ä»¥ï¼Œä»ç³»ç»Ÿå±‚é¢åªèƒ½çœ‹åˆ° JVM çš„å‡½æ•°å †æ ˆï¼Œè€Œä¸èƒ½ç›´æ¥å¾—åˆ° Java åº”ç”¨ç¨‹åºçš„å †æ ˆã€‚é‚£æˆ‘ä»¬å¥½èƒ½é€šè¿‡ perf å»çœ‹åˆ° java ç›¸å…³çš„å †æ ˆå—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚

å¯ä»¥å€ŸåŠ© [perf-map-agent](https://github.com/jvm-profiling-tools/perf-map-agent) è¿™æ ·çš„å¼€æºå·¥å…·ï¼Œå»ç”Ÿæˆå’Œ`perf` å·¥å…·ä¸€èµ·ä½¿ç”¨çš„æ–¹æ³•æ˜ å°„ï¼Œä½†æ˜¯éœ€è¦åšé¢å¤–çš„ä¸€äº›é…ç½®ã€‚è¿™é‡Œçš„æ–¹æ³•å¤§å®¶å¯ä»¥è‡ªå·±æ¢ç©¶ï¼Œä¸ºä»€ä¹ˆä¸è¯¦ç»†çš„è®²è¿™ä¸ªå‘¢ï¼ŒåŸå› ä¹Ÿç®€å•ï¼Œæ’æŸ¥é—®é¢˜çš„å·¥å…·å¤šç§å¤šæ ·ï¼Œæ²¡å¿…è¦åœ¨ä¸€æ£µæ ‘ä¸ŠåŠæ­»ã€‚

#### jstack

æ—¢ç„¶ perf top å»æŸ¥çœ‹ JAVA çš„è°ƒç”¨æ ˆä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬å°±ç›´æ¥ä¸Š java æä¾›çš„ jstack å·¥å…·å»åˆ†æã€‚
- jstack -l pid > xxx.txt éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlinuxç³»ç»Ÿä¸­å¾€å¾€ä¼šç”¨ä¸åŒçš„ç”¨æˆ·å»æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæ­¤æ—¶å¯èƒ½éœ€è¦é€šè¿‡sudu -u xxx jstackçš„å½¢å¼
- kill -3ï¼Œ jstack ç”¨ä¸äº†çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ kill -3 pid çš„å½¢å¼ï¼Œå †æ ˆä¼šè¾“å‡ºåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­ã€‚

å…·ä½“çš„æ“ä½œæ­¥éª¤:
1. `top -Hp $pid` æ‰¾åˆ°å ç”¨ CPU çš„å…·ä½“çº¿ç¨‹
2. `jstack -l $pid > /tmp/$pid.jstack` æˆ–è€… `kill -3 $pid`å°† java è¿›ç¨‹çš„å †æ ˆæƒ…å†µè¾“å‡ºçš„æ—¥å¿—ä¸­ï¼Œç„¶åæ ¹æ® `top -Hp` çœ‹åˆ°çš„çº¿ç¨‹ä¿¡æ¯åœ¨è¾“å‡ºçš„å †æ ˆæ—¥å¿—ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼ˆ`top -Hp` è¾“å‡ºçš„æ˜¯ 10 è¿›åˆ¶çš„ idï¼Œ`jstack` è¾“å‡ºçš„æ˜¯ 16 è¿›åˆ¶çš„ï¼Œåœ¨æŸ¥æ‰¾æ—¶æ³¨æ„è¿›åˆ¶è½¬æ¢ï¼‰

æˆ‘ä»¬çœ‹ä¸‹ä¸Šé¢ java ç¨‹åºçš„å †æ ˆçš„ä¿¡æ¯:
``` Lua
2024-08-16 15:15:40
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.221-b11 mixed mode):

"Attach Listener" #35 daemon prio=9 os_prio=0 tid=0x00007f52b4001000 nid=0x71f4 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"DestroyJavaVM" #34 prio=5 os_prio=0 tid=0x00007f53e0009800 nid=0x1693 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"Thread-1" #25 prio=5 os_prio=0 tid=0x00007f53e015a800 nid=0x16d9 runnable [0x00007f52f64e3000]
   java.lang.Thread.State: RUNNABLE
	at sun.misc.Unsafe.getObjectVolatile(Native Method)
	at java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:755)
	at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:938)
	at java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:267)
	at java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:227)
	at java.time.ZoneRegion.ofId(ZoneRegion.java:120)
	at java.time.ZoneId.of(ZoneId.java:411)
	at java.time.ZoneId.of(ZoneId.java:359)
	at java.time.ZoneId.of(ZoneId.java:315)
	at java.util.TimeZone.toZoneId(TimeZone.java:556)
	at java.time.ZoneId.systemDefault(ZoneId.java:274)
	at java.time.Clock.systemDefaultZone(Clock.java:178)
	at java.time.LocalDateTime.now(LocalDateTime.java:180)
	at Main$1.run(Main.java:12)
	at java.lang.Thread.run(Thread.java:748)

   Locked ownable synchronizers:
	- None

"Thread-0" #24 prio=5 os_prio=0 tid=0x00007f53e0159000 nid=0x16d8 runnable [0x00007f52f65e4000]
   java.lang.Thread.State: RUNNABLE
	at sun.misc.Unsafe.getObjectVolatile(Native Method)
	at java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:755)
	at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:938)
	at java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:267)
	at java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:227)
	at java.time.ZoneRegion.ofId(ZoneRegion.java:120)
	at java.time.ZoneId.of(ZoneId.java:411)
	at java.time.ZoneId.of(ZoneId.java:359)
	at java.time.ZoneId.of(ZoneId.java:315)
	at java.util.TimeZone.toZoneId(TimeZone.java:556)
	at java.time.ZoneId.systemDefault(ZoneId.java:274)
	at java.time.Clock.systemDefaultZone(Clock.java:178)
	at java.time.LocalDateTime.now(LocalDateTime.java:180)
	at Main$1.run(Main.java:12)
	at java.lang.Thread.run(Thread.java:748)

   Locked ownable synchronizers:
	- None
 --- 10 ä¸ª thread

"Service Thread" #23 daemon prio=9 os_prio=0 tid=0x00007f53e0143800 nid=0x16d6 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"C2 CompilerThread1" #6 daemon prio=9 os_prio=0 tid=0x00007f53e010e000 nid=0x16c5 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None
 --- ä¸€å¤§å † C2 CompilerThread

"C2 CompilerThread0" #5 daemon prio=9 os_prio=0 tid=0x00007f53e010b000 nid=0x16c4 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"Signal Dispatcher" #4 daemon prio=9 os_prio=0 tid=0x00007f53e0109800 nid=0x16c3 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"Finalizer" #3 daemon prio=8 os_prio=0 tid=0x00007f53e00d8800 nid=0x16c2 in Object.wait() [0x00007f52f7bfa000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on <0x000000008021a5e8> (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
	- locked <0x000000008021a5e8> (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)
	at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216)

   Locked ownable synchronizers:
	- None

"Reference Handler" #2 daemon prio=10 os_prio=0 tid=0x00007f53e00d3800 nid=0x16c1 in Object.wait() [0x00007f52f7cfb000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on <0x0000000080218d38> (a java.lang.ref.Reference$Lock)
	at java.lang.Object.wait(Object.java:502)
	at java.lang.ref.Reference.tryHandlePending(Reference.java:191)
	- locked <0x0000000080218d38> (a java.lang.ref.Reference$Lock)
	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)

   Locked ownable synchronizers:
	- None

"VM Thread" os_prio=0 tid=0x00007f53e00ca000 nid=0x16c0 runnable

"GC task thread#0 (ParallelGC)" os_prio=0 tid=0x00007f53e001f000 nid=0x1694 runnable

--- ä¸€å¤§å † GC task thread

"VM Periodic Task Thread" os_prio=0 tid=0x00007f53e0146000 nid=0x16d7 waiting on condition

JNI global references: 202
```
æˆ‘ä»¬é€šè¿‡ top -Hp çš„ä¿¡æ¯å°±å¯ä»¥å¿«é€Ÿå®šä½åˆ° Thread-[0-9] è¿™å‡ ä¸ªçº¿ç¨‹ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨æ ˆéƒ½æ˜¯ `java.time.LocalDateTime.now`, ä¹Ÿè¯´æ˜äº†è¿™ä¸ªæ–¹æ³•åœ¨ä¸åœæ¶ˆè€— CPUã€‚ï¼ˆä½†æ˜¯ jstack åªèƒ½æ•è·çŸ­æ—¶é—´æˆ–è€…ç¬æ—¶çš„å †æ ˆä¿¡æ¯ï¼Œæ²¡æ³•å¤„ç†é•¿æ—¶é—´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è·å–æ—¶å¯ä»¥å¤šæ‰“å°å‡ æ¬¡æˆ–è€…ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼‰

è‡³äº jstack çš„è¯¦ç»†ç”¨æ³•ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšå®¢ï¼š[javaé—®é¢˜å®šä½](https://baixiaozhou.github.io/2024/08/13/JAVA%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/)

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰éå¸¸å¤šçš„åˆ†æå·¥å…·ï¼Œpstack\gstack\strace\gdbç­‰ç­‰ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæ¢ç´¢ä½¿ç”¨

#### ç«ç„°å›¾

ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šæ“ä½œçš„å‘½ä»¤å’Œæ–¹æ³•ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ¯”è¾ƒç›´è§‚çš„æ–¹å¼èƒ½å¤Ÿç›´æ¥çœ‹åˆ°å„ç§æ–¹æ³•æ‰§è¡Œçš„è€—æ—¶æ¯”é‡ç­‰æƒ…å†µå‘¢ï¼Ÿç«ç„°å›¾å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µè€Œç”Ÿçš„ã€‚

ç«ç„°å›¾çš„åˆ†ç±»æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„åŒ…æ‹¬:
1. CPU ç«ç„°å›¾ (CPU Flame Graph)
	-	æè¿°ï¼šå±•ç¤º CPU åœ¨ä¸åŒæ–¹æ³•ä¸Šçš„æ¶ˆè€—æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨æ‰€å ç”¨çš„ CPU æ—¶é—´ã€‚
	-	ç”¨é€”ï¼šç”¨äºåˆ†æ CPU æ€§èƒ½ç“¶é¢ˆï¼Œè¯†åˆ«å“ªäº›æ–¹æ³•æ¶ˆè€—äº†æœ€å¤šçš„ CPU èµ„æºã€‚
	-	åº”ç”¨ï¼šJavaã€C++ ç­‰å¤šç§ç¼–ç¨‹è¯­è¨€çš„æ€§èƒ½åˆ†æã€‚
2. å†…å­˜ç«ç„°å›¾ (Memory Flame Graph)
	- æè¿°ï¼šå±•ç¤ºå†…å­˜åˆ†é…æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨åˆ†é…çš„å†…å­˜é‡ã€‚
    - ç”¨é€”ï¼šç”¨äºæ£€æµ‹å†…å­˜æ³„æ¼ã€è¿‡åº¦å†…å­˜åˆ†é…é—®é¢˜ï¼Œå¸®åŠ©ä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚
	- åº”ç”¨ï¼šå¸¸ç”¨äºåˆ†æå†…å­˜å¯†é›†å‹åº”ç”¨ï¼Œå¦‚ Java åº”ç”¨çš„å †å†…å­˜åˆ†æã€‚
3. I/O ç«ç„°å›¾ (I/O Flame Graph)
	-	æè¿°ï¼šå±•ç¤º I/O æ“ä½œçš„è€—æ—¶æƒ…å†µï¼Œæ˜¾ç¤ºä¸åŒæ–¹æ³•çš„ I/O æ“ä½œå ç”¨çš„æ—¶é—´ã€‚
	-	ç”¨é€”ï¼šç”¨äºåˆ†æåº”ç”¨ç¨‹åºçš„ I/O æ€§èƒ½ï¼Œè¯†åˆ«æ…¢é€Ÿæˆ–é¢‘ç¹çš„ I/O æ“ä½œã€‚
	-	åº”ç”¨ï¼šæ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯çš„æ€§èƒ½è°ƒä¼˜ã€‚

æˆ‘ä»¬è¿™é‡Œé€šè¿‡ [async-profiler](https://github.com/async-profiler/async-profiler) å¯¹æ–‡ç« ä¸Šé¢çš„javaå‹æµ‹ç¨‹åºè¿›è¡ŒæŠ“å–(è¿™ä¸ªå·¥å…·åªèƒ½æŠ“ java çš„)

```
tar -xzf async-profiler-3.0-linux-x64.tar.gz
cd async-profiler-3.0-linux-x64/bin
./asprof -d 60 pid -f /tmp/javastress.html
```
æˆ‘ä»¬ç”¨æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ html æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ç«ç„°å›¾ä¿¡æ¯ï¼ˆå¯ä»¥åœ¨ç½‘é¡µè¿›è¡Œç‚¹å‡»ï¼ŒæŸ¥çœ‹æ›´ç»†èŠ‚çš„æ–¹æ³•ï¼‰
![java ç¨‹åºçš„ç«ç„°å›¾](../images/javafire.png)

è¿™æ ·çœ‹èµ·æ¥å°±æ¯” jstackè¿™äº›ä¿¡æ¯æ›´åŠ ç›´è§‚ä¸€ç‚¹ã€‚

## è´Ÿè½½é£™å‡

### è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½

æˆ‘ä»¬å…ˆçœ‹ä¸‹ç³»ç»Ÿè´Ÿè½½çš„å®˜æ–¹æè¿°:
```
System load averages is the average number of processes that are either in a runnable or uninterruptable state. A process in arunnable state is either using the CPU or waiting to use the CPU.  A process in uninterruptable state is waiting for some I/O access,eg waiting for disk.  The averages are taken over the three time intervals.  Load averages are not normalized for the number of CPUs ina  system,  so a load average of 1 means a single CPU system is loaded all the time while on a 4 CPU system it means it was idle 75% of the time.
```

ç³»ç»Ÿè´Ÿè½½å¹³å‡å€¼è¡¨ç¤ºå¤„äºå¯è¿è¡Œæˆ–ä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹çš„å¹³å‡æ•°é‡ã€‚å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹è¦ä¹ˆæ­£åœ¨ä½¿ç”¨ CPUï¼Œè¦ä¹ˆæ­£åœ¨ç­‰å¾…ä½¿ç”¨ CPUã€‚å¤„äºä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸäº› I/O è®¿é—®ï¼Œä¾‹å¦‚ç­‰å¾…ç£ç›˜ã€‚è¿™é‡Œçš„æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯ loadavg è¿™ä¸ªæ•°å€¼ä½“ç°äº†æŸäº›ç‰¹å®šçŠ¶æ€è¿›ç¨‹çš„æ•°é‡ã€‚

é‚£å¼•ç”³å‡ºä¸¤ä¸ªé—®é¢˜:
1. è¿›ç¨‹çš„çŠ¶æ€æœ‰å“ªäº›ï¼Ÿ
2. å¯è¿è¡Œå’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆ

é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ï¼Œè¿›ç¨‹çš„çŠ¶æ€å’Œå…·ä½“å«ä¹‰:
- D    uninterruptible sleep (usually IO)
- R    running or runnable (on run queue)
- S    interruptible sleep (waiting for an event to complete)
- T    stopped by job control signal
- t    stopped by debugger during the tracing
- W    paging (not valid since the 2.6.xx kernel)
- X    dead (should never be seen) 
- Z    defunct ("zombie") process, terminated but not reaped by its parent

è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å¤„äºä¸å¯ä¸­æ–­çš„çŠ¶æ€çš„è¿›ç¨‹å’Œæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åˆ†åˆ«ä¸º `D` å’Œ `R`,æ¢ä¸ªè¯´æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´é€ æˆè´Ÿè½½å‡é«˜çš„åŸå› ä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªçŠ¶æ€çš„è¿›ç¨‹å¼•èµ·çš„ã€‚

ï¼ˆæ’ä¸ªé¢˜å¤–è¯ï¼ŒæŒ‰ç…§å®˜æ–¹çš„è¯´æ³•ï¼ŒX çŠ¶æ€çš„è¿›ç¨‹åº”è¯¥æ˜¯ä¸åº”è¯¥è¢«çœ‹åˆ°çš„ï¼Œ ä½†æ˜¯ä¹‹å‰åœ¨è…¾è®¯äº‘åšESçš„æ—¶å€™ï¼Œå¶ç„¶é—´ç¢°åˆ°äº†ä¸€æ¬¡ï¼Œå½“æ—¶è¿˜æˆªäº†ä¸ªå›¾ç”¨åšç•™å¿µğŸ˜‚ï¼Œä½†æ˜¯æ²¡æœ‰æ•è·åˆ°å…·ä½“çš„ä¿¡æ¯ï¼‰

è´Ÿè½½çš„æŒ‡æ ‡å¯ä»¥é€šè¿‡ `top` ä»¥åŠ `uptime` æŒ‡ä»¤è·å–
```
23:35:00 up 1 day, 46 min,  1 user,  load average: 49.16, 18.35, 7.87
```
è¿™é‡Œå±•ç¤ºäº† loadavg çš„ä¸‰ä¸ªæ•°å€¼: åˆ†åˆ«ä»£è¡¨çš„å«ä¹‰æ˜¯ 1minã€5minã€15min çš„ç³»ç»Ÿå¹³å‡è´Ÿè½½

### CPUçš„ä½¿ç”¨æƒ…å†µ VS loadavg

æ—¢ç„¶è¯´æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¼šå¼•èµ·è´Ÿè½½çš„å˜åŒ–ï¼Œé‚£ä¹ˆè·‘ä¸€äº›ç¨‹åºï¼Œè®©ç¨‹åºä¸åœè¿è¡Œï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶å°±èƒ½æ„é€ å‡ºæŒç»­è¿è¡Œçš„è¿›ç¨‹äº†ã€‚
æˆ‘è¿™é‡Œæ‰¾äº†ä¸‰å°æœºå™¨(64C)ï¼Œç”¨æˆ‘çš„å‹æµ‹å·¥å…·å…ˆè·‘ä¸€äº›çº¯ CPU çš„è¿ç®—ï¼Œç„¶åè§‚å¯Ÿä¸‹æ•ˆæœï¼š

æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹:
1. 10 å¹¶å‘ 30min
   -  `nohup ./sysstress cpu --cpu-number 10 --duration 30m > /dev/null 2>&1`
2. 30 å¹¶å‘ 30min
   - `nohup ./sysstress cpu --cpu-number 30 --duration 30m > /dev/null 2>&1`
3. 60 å¹¶å‘ 30min
   - `nohup ./sysstress cpu --cpu-number 60 --duration 30m > /dev/null 2>&1`

æ•ˆæœå¦‚ä¸‹:
![10å¹¶å‘è´Ÿè½½](../images/load10.png)
![30å¹¶å‘è´Ÿè½½](../images/load30.png)
![60å¹¶å‘è´Ÿè½½](../images/load60.png)

ä»ä¸Šè¿°æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨çº¯è¿ç®—è¿™ç§åœºæ™¯ä¸‹ï¼Œå¹¶å‘çš„é‡åŸºæœ¬ä¸Šå’Œè´Ÿè½½æ˜¯å¯¹åº”çš„ã€‚ä¹Ÿå°±æ˜¯è¯´éšç€ CPUçš„ä½¿ç”¨é‡ ä¸Šæ¶¨ï¼Œè´Ÿè½½ä¹Ÿä¼šä¸æ–­å˜é«˜ã€‚
