---
title: çº¿ä¸Šæ•…éšœæ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä»‹ç»
author: baixiaozhou
categories:
  - é—®é¢˜æ’æŸ¥
tags:
  - Linux
  - Java
  - Golang
  - commands
description: çº¿ä¸Šæ•…éšœé—®é¢˜çš„æ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä»‹ç»ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€è´Ÿè½½ã€ç£ç›˜ã€IOã€ç½‘ç»œç­‰
date: 2024-08-15 11:12:21
references:
  - '[Examining Load Average](https://www.linuxjournal.com/article/9001)'
  - '[What-is-CPU-Load-Average](https://community.tenable.com/s/article/What-is-CPU-Load-Average)'
cover: /images/server.jpg
banner: /images/server.jpg
repo: baixiaozhou/SysStress
---

<!-- more -->

{% quot å‚è€ƒæ–‡æ¡£ %}

[Examining Load Average](https://www.linuxjournal.com/article/9001)
[What-is-CPU-Load-Average](https://community.tenable.com/s/article/What-is-CPU-Load-Average)
[Brendan Greggä¸ªäººç½‘ç«™](www.brendangregg.com)


## å†™åœ¨å‰é¢

åœ¨å¾ˆå¤šæ–‡ç« ä¸­ï¼Œæ¯å½“æåˆ°å»è§£å†³çº¿ä¸Šé—®é¢˜çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†çš„å¤„ç†æ–¹å¼å°±æ˜¯ç™»å½•ç¯å¢ƒï¼Œå“å“å„ç§æ•²å‘½ä»¤ã€‚æ“ä½œæœ¬èº«æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šäººè€Œè¨€ï¼Œæˆ‘è§‰å¾—è¿™ç§åšæ³•å…¶å®æ˜¯æœ¬æœ«å€’ç½®çš„ï¼Œè¿‡äºåœ¨ä¹å»å¿«é€ŸæŠ“ä½é‡ç‚¹é—®é¢˜ï¼Œè€Œå¿½ç•¥äº†ä»å…¨å±€å»çœ‹é—®é¢˜ã€‚é‚£ä¹ˆå¦‚æœæœ€å¼€å§‹ä¸å»æ“ä½œå„ç§å‘½ä»¤ï¼Œé‚£åº”è¯¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿ

***çœ‹ç›‘æ§ï¼ï¼ï¼ï¼***

é¦–å…ˆä¸è¦è§‰å¾—è¿™ä¸ªæ˜¯åºŸè¯ï¼Œå¯¹äºå¾ˆå¤šåœºæ™¯æ¥è¯´ï¼Œä¸šåŠ¡è§„æ¨¡æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œæœ‰çš„æ—¶å€™å¹¶å‘è¶…è¿‡äº†æé™çš„æ€§èƒ½ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹éƒ½æ²¡æœ‰å¿…è¦å»åå°è¿›è¡Œå„ç§æŸ¥è¯¢ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡å¦‚è¯´æŸå¥—ä¸šåŠ¡ç³»ç»Ÿï¼Œæœ¬èº«åªèƒ½æ”¯æŒ 500 å¹¶å‘ï¼Œç°åœ¨å®é™…ä¸Šçš„é‡åˆ°äº† 2000ï¼Œå¯¼è‡´çº¿ä¸Šå„ç§å†…å­˜ã€CPUã€è´Ÿè½½çš„å‘Šè­¦ï¼Œè¿™ç§æƒ…å†µä¸‹è¿˜æœ‰å¿…è¦å»åå°æ•²`top`ã€`free`å—ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯å¦å®šçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦è€ƒè™‘å¯¹ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œå¿«é€Ÿçš„æ‰©å®¹ç­‰ã€‚

çœ‹ç›‘æ§çš„æ„ä¹‰åœ¨äºå°½å¯èƒ½çš„æ‰¾åˆ°æ›´å¤šçš„æ€§èƒ½ç“¶é¢ˆæˆ–è€…å¼‚å¸¸çš„ç‚¹ï¼Œä»å…¨å±€å‡ºå‘ï¼Œå¯¹ç³»ç»Ÿå½“å‰å­˜åœ¨çš„é—®é¢˜å’Œå¼‚å¸¸ç‚¹æœ‰å…¨é¢çš„äº†è§£ã€‚

ç›‘æ§ç³»ç»Ÿå¤šç§å¤šæ ·ï¼Œä»è¾ƒæ—©çš„ zabbix åˆ°ç°åœ¨æ¯”è¾ƒæµè¡Œçš„prometheus+grafanaï¼ˆä¸¾ä¸¤ä¸ªå¸¸ç”¨çš„ä¾‹å­ï¼‰ï¼Œå¯¹äºç³»ç»Ÿä¸šåŠ¡éƒ½æœ‰æ¯”è¾ƒå®Œå–„çš„ç›‘æ§ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ å…·ä½“çš„äº†è§£åˆ°ç³»ç»Ÿè¿è¡Œå…¨è²Œã€‚å¦‚æœä½ å¯¹è¿™äº›éƒ½ä¸å–œæ¬¢ï¼Œé‚£ä¹ˆä½ è‡ªå·±å†™ä¸€ä¸ªç›‘æ§ç³»ç»Ÿä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚

å½“æˆ‘ä»¬çœ‹å®Œç›‘æ§ä¹‹åï¼ˆå‡è®¾ä½ çœŸçš„çœ‹äº†ï¼‰ï¼Œæ¥ä¸‹æ¥è¿›å…¥å®é™…æ“ä½œç¯èŠ‚ï¼Œæˆ‘ä¼šä»è¿™äº›æŒ‡æ ‡çš„è¯¦ç»†å«ä¹‰å‡ºå‘ï¼Œç„¶åå°½å¯èƒ½åœ°å°†å„ç§å¤„ç†æ–¹å¼åˆ†äº«ç»™å¤§å®¶ã€‚

## Linuxæ€§èƒ½è°±å›¾

åœ¨åˆ†æé—®é¢˜å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ˜ç¡® Linux æœ‰å“ªäº›æ€§èƒ½åˆ†æå·¥å…·ï¼Œæˆ‘ä»¬å…ˆä¸Šä¸€ä¸‹LINUX æ€§èƒ½ä¸“å®¶ Brendan Gregg æ€»ç»“çš„å›¾ï¼ˆå¤§å®¶å¦‚æœå¯¹æ€§èƒ½åˆ†æç­‰æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è®¤çœŸçœ‹ä¸‹è¿™ä½å¤§ä½¬çš„ä¸ªäººç½‘ç«™ï¼‰:

{% image https://www.brendangregg.com/Perf/linux_observability_tools.png Linux Performance Observability Tool fancybox:true %}

ä¸Šé¢è¿™å¼ å›¾æ˜¯å¼•ç”¨å¤§ä½¬æ–‡ç« çš„å›¾ï¼ŒåŸæ–‡é“¾æ¥åœ¨è¿™é‡Œ: https://www.brendangregg.com/linuxperf.html

## CPUä½¿ç”¨ç‡é£™å‡

### å¦‚ä½•è®©CPUä½¿ç”¨ç‡é£™å‡

è¿™ä¸ªé—®é¢˜å…¶å®å¾ˆç®€å•ï¼Œåªè¦æœ‰è®¡ç®—ä»»åŠ¡ä¸€ç›´å­˜åœ¨ï¼Œè®© CPU ä¸€ç›´å¤„äºç¹å¿™ä¹‹ä¸­ï¼Œé‚£ä¹ˆ CPU å¿…ç„¶é£™å‡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ç³»åˆ—çš„å·¥å…·å»æ¨¡æ‹Ÿè¿™ä¸ªæƒ…å†µã€‚

[github SysStress](https://github.com/baixiaozhou/SysStress) è¿™æ˜¯æˆ‘è‡ªå·±ç”¨ golang å†™çš„å‹æµ‹å·¥å…·(è¿˜åœ¨å¼€å‘ä¸­ï¼Œå¯ä»¥ç‚¹ä¸ª star è®©æˆ‘æ›´æœ‰åŠ¨åŠ›ğŸ˜‚)

ä½¿ç”¨æ–¹æ³•:
```
./sysstress cpu --cpu-number 10 --duration 10m
```
è¿™ä¸ªå°±æ˜¯æ¨¡æ‹Ÿå ç”¨ 10 æ ¸å¿ƒçš„ CPU å¹¶æŒç»­ 10minï¼Œå½“ç„¶å¤§å®¶ä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„å‹æµ‹å·¥å…·ï¼Œæ¯”å¦‚`stress-ng`

### å¦‚ä½•åˆ¤æ–­å’Œå‘ç°CPUä½¿ç”¨ç‡é£™å‡

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼Œè·Ÿ CPU ä½¿ç”¨ç‡ç›¸å…³çš„æœ‰å“ªäº›æŒ‡æ ‡ã€‚æˆ‘ä»¬é€šè¿‡ `top` å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°å…·ä½“çš„ä¿¡æ¯

{% image /images/top.png top fancybox:true %}
<!-- ![top](../images/top.png) -->
è¿™äº›è¾“å‡ºä¸­æœ‰ä¸€è¡Œæ˜¯ `%Cpu(s)`, è¿™è¡Œå±•ç¤ºäº† CPU çš„æ•´ä½“ä½¿ç”¨æƒ…å†µï¼Œæ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”çš„å½¢å¼ï¼Œæˆ‘ä»¬è¯¦ç»†é˜è¿°ä¸‹è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰
```
us, user    : time running un-niced user processes   æœªé™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´
sy, system  : time running kernel processes          å†…æ ¸è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´
ni, nice    : time running niced user processes      é™ä½ä¼˜å…ˆçº§çš„ç”¨æˆ·è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´
id, idle    : time spent in the kernel idle handler  ç©ºé—²çš„æ—¶é—´
wa, IO-wait : time waiting for I/O completion        ç­‰å¾… I/O æ“ä½œå®Œæˆæ‰€èŠ±è´¹çš„æ—¶é—´
hi : time spent servicing hardware interrupts        å¤„ç†ç¡¬ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´
si : time spent servicing software interrupts        å¤„ç†è½¯ä»¶ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´
st : time stolen from this vm by the hypervisor      è¢«è™šæ‹Ÿæœºç®¡ç†ç¨‹åºä»æ­¤è™šæ‹Ÿæœºä¸­çªƒå–çš„æ—¶é—´
```
åœ¨è¿™äº›æŒ‡æ ‡ä¸­ï¼Œä¸€èˆ¬å…³æ³¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯ usã€syã€idã€waï¼ˆå…¶ä»–å‡ ä¸ªæŒ‡æ ‡å¾ˆé«˜çš„æƒ…å†µæˆ‘ä¸ªäººç›®å‰åŸºæœ¬ä¸Šæ²¡æœ‰é‡åˆ°è¿‡ï¼‰

ä¸Šè¿°æŒ‡æ ‡åæ˜ äº†ç³»ç»Ÿæ•´ä½“çš„ CPU æƒ…å†µã€‚è€Œç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­å®é™…ä¸Šæ˜¯ä»¥ä¸€ä¸ªä¸ªçš„è¿›ç¨‹å­˜åœ¨çš„ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•ç¡®å®šåˆ°å ç”¨ CPU é«˜çš„è¿›ç¨‹å‘¢ï¼Ÿè®©æˆ‘ä»¬çš„ç›®å…‰ä» top çš„å¤´éƒ¨ä¿¡æ¯å¾€ä¸‹ç§»åŠ¨ï¼Œä¸‹é¢å°±å±•ç¤ºäº†è¯¦ç»†çš„è¿›ç¨‹ä¿¡æ¯
{% image /images/top-process.png fancybox:true %}
<!-- !cess](../imagescess.png) -->

è¿™äº›ç¨‹åºé»˜è®¤æ˜¯æŒ‰ç…§ CPU çš„ä½¿ç”¨ç‡ä»é«˜åˆ°åº•è¿›è¡Œæ’åºçš„ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡åœ¨`top`çš„æ—¶å€™è¾“å…¥`P`è¿›è¡Œæ’åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­æ¶ˆè€— CPU èµ„æºçš„è¯¦ç»†è¿›ç¨‹ä¿¡æ¯

ä¸Šé¢æ˜¯æˆ‘é€šè¿‡ `./sysstress cpu --cpu-number 10 --duration 10m` å‹æµ‹ç¨‹åºè·‘å‡ºæ¥çš„ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ sysstress ç¨‹åºå ç”¨äº† 1002 çš„ %CPUï¼Œä¹Ÿå°±æ˜¯è¯´åŸºæœ¬ä¸Šæ˜¯ 10 ä¸ªæ ¸å¿ƒï¼Œé‚£æˆ‘ä»¬è·‘ä¸€ä¸ªæ›´é«˜çš„ï¼Œå°†`--cpu-number`åŠ åˆ° 60 çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ
<!-- ![stress-cpu](../images/stress-cpu.png) -->
{% image /images/stress-cpu.png stress-cpu fancybox:true %}

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ¬¡%CPUæ‰“åˆ°äº† 6000ï¼Œé‚£å¾ˆå¤šäººå°±å¥½å¥‡æˆ‘æ—¥å¸¸çš„ç¨‹åºè·‘åˆ°å¤šé«˜ç®—é«˜å‘¢ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼Œç°åœ¨çš„æœåŠ¡å™¨ç»å¤§éƒ¨åˆ†éƒ½æ˜¯å¤šæ ¸å¿ƒ CPUï¼ˆ1C2Gè¿™ç§è‡ªå·±ç”¨æ¥ç©çš„å¿½ç•¥ï¼‰ï¼ŒCPU çš„æ ¸å¿ƒæ•°å†³å®šäº†æˆ‘ä»¬ç¨‹åºåœ¨åŒä¸€æ—¶é—´èƒ½å¤Ÿæ‰§è¡Œå¤šå°‘ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªé«˜ä¸é«˜æ˜¯ç›¸å¯¹äºæœºå™¨é…ç½®è€Œè¨€çš„ã€‚å¦‚æœä½ çš„æœºå™¨åªæœ‰ 16Cï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 1000ï¼Œé‚£ä¹ˆå…¶å®å·²ç»ç®—æ˜¯æ¯”è¾ƒé«˜äº†ã€‚å¦‚æœæ˜¯ 256C çš„CPUï¼ˆåœŸè±ªçº§é…ç½®ï¼‰ï¼Œé‚£ä¹ˆå•ä¸ªè¿›ç¨‹å ç”¨çš„ %CPU åˆ° 6000ï¼Œå¯¹äºç³»ç»Ÿçš„ç¨³å®šæ€§å½±å“å°±æ²¡æœ‰é‚£ä¹ˆå¤§äº†ã€‚

ä¸Šè¿°æˆ‘ä»¬è¯´çš„æƒ…å†µæ˜¯è¿›ç¨‹å ç”¨ CPU å¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ï¼Œé‚£ä¹ˆè¿›ç¨‹å ç”¨çš„ CPU å¯¹ç³»ç»Ÿçš„å½±å“ä¸å¤§å°±ä»£è¡¨è¿™ä¸ªç¨‹åºä¸€å®šæ²¡æœ‰é—®é¢˜å—ï¼Ÿç­”æ¡ˆæ˜¾ç„¶æ˜¯æœªå¿…çš„ã€‚

æˆ‘ä»¬è¿˜æ˜¯è¦å›å½’åˆ°ä¸šåŠ¡æœ¬èº«ï¼Œå¦‚æœè¿›ç¨‹çš„ CPU å ç”¨åœ¨ä¸šåŠ¡å˜åŠ¨ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œå‘ç”Ÿäº†å¼‚å¸¸æ³¢åŠ¨ï¼Œæˆ–è€…æ­£å¸¸æƒ…å†µä¸‹ä¸šåŠ¡ä¸ä¼šæ¶ˆè€—è¿™ä¹ˆé«˜çš„ CPUï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç»§ç»­æ’æŸ¥äº†ã€‚

### å¦‚ä½•ç¡®å®šCPUé£™å‡çš„æ ¹æº
è¿™ä¸ªé—®é¢˜çš„ æ ¸å¿ƒæ˜¯ CPU ä¸Šåœ¨è¿è¡Œä»€ä¹ˆä¸œè¥¿ã€‚ å¤šæ ¸å¿ƒCPU ä¸‹ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½å¯ä»¥æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šä¸€ä¸ªè¿›ç¨‹ä¸­é‚£äº›æ–¹æ³•åœ¨æ¶ˆè€— CPU å‘¢ï¼Ÿä»è€Œå¼•ç”³ä¸‹é¢è¯¦ç»†çš„é—®é¢˜:
 1. ç¨‹åºçš„è°ƒç”¨æ ˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ
 2. è°ƒç”¨æ ˆä¿¡æ¯ä¸­å“ªäº›æ˜¯éœ€è¦å…³æ³¨çš„ï¼Œé‚£äº›æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Ÿ
 3. çƒ­ç‚¹å‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿ

è€è¯è¯´å¾—å¥½ï¼Œ"å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨", æˆ‘ä»¬éœ€è¦è¿™äº›ä¸œè¥¿ï¼Œå°±å¿…é¡»äº†è§£åˆ°ä»€ä¹ˆæ ·çš„å·¥å…·å¯ä»¥æ‹¿åˆ°ä¸Šé¢æˆ‘æåˆ°çš„ä¸€äº›ä¿¡æ¯ã€‚æ¥ä¸‹æ¥æˆ‘å°†é€šè¿‡å¸¸ç”¨çš„åç«¯è¯­è¨€ï¼š`golang` å’Œ `java` ä¸ºä¾‹æ„é€ ä¸€äº›é«˜ CPU çš„ç¨‹åºæ¥è¿›è¡Œå±•ç¤ºã€‚

#### perfå‘½ä»¤
**perfæ˜¯ä¸€æ¬¾Linuxæ€§èƒ½åˆ†æå·¥å…·ã€‚Linuxæ€§èƒ½è®¡æ•°å™¨æ˜¯ä¸€ä¸ªæ–°çš„åŸºäºå†…æ ¸çš„å­ç³»ç»Ÿï¼Œå®ƒæä¾›ä¸€ä¸ªæ€§èƒ½åˆ†ææ¡†æ¶ï¼Œæ¯”å¦‚ç¡¬ä»¶ï¼ˆCPUã€PMU(Performance Monitoring Unit)ï¼‰åŠŸèƒ½å’Œè½¯ä»¶(è½¯ä»¶è®¡æ•°å™¨ã€tracepoint)åŠŸèƒ½ã€‚**

å®‰è£…:
```
yum install perf   #Centos
```
å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆçœ‹ä¸‹ `perf`çš„ç”¨æ³•ï¼Œè¿™é‡Œä¸å±•å¼€å…·ä½“ç”¨æ³•ï¼Œåªåˆ—å‡ºæˆ‘å¹³å¸¸ä½¿ç”¨çš„å‡ ä¸ªå‘½ä»¤:
```
top        System profiling tool.               #å¯¹ç³»ç»Ÿæ€§èƒ½è¿›è¡Œå®æ—¶åˆ†æã€‚
record     Run a command and record its profile into perf.data     #æ”¶é›†é‡‡æ ·ä¿¡æ¯
report     Read perf.data (created by perf record) and display the profile  #åˆ†æé‡‡æ ·ä¿¡æ¯ï¼Œå’Œrecordé…åˆä½¿ç”¨
```
record å’Œ report çš„ä½¿ç”¨æ›´å¤šåœ¨äº dump å½“å‰ç¯å¢ƒçš„ä¿¡æ¯ç”¨äºåç»­åˆ†æï¼Œå¦‚æœåœ¨è‡ªå·±ç¯å¢ƒä¸Šæµ‹è¯•ï¼Œå¯ä»¥ç”¨ top è¿›è¡Œä¸€äº›ç®€å•çš„å®æ—¶åˆ†æï¼ˆç±»ä¼¼äº top å‘½ä»¤ï¼‰ã€‚

è¿˜æ˜¯ç”¨ä¹‹å‰çš„å‹æµ‹å·¥å…·ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ª 10 æ ¸å¿ƒçš„ 10min çš„å‹æµ‹åœºæ™¯
```
nohup ./sysstress cpu --cpu-number 10 --duration 10m > /dev/null 2>&1 &
```
æ‰§è¡Œè¿™ä¸ªè¯­å¥ï¼Œè®©å‹æµ‹ç¨‹åºåœ¨åå°æ‰§è¡Œï¼Œç„¶åæˆ‘ä»¬é€šè¿‡`perf top`æŸ¥çœ‹å…·ä½“çš„æƒ…å†µï¼ˆå¯ä»¥é€šè¿‡-p æŒ‡å®š pidï¼‰

{% image /images/perftop.png perf top, fancybox:true %}
<!-- ![perf top](../images/perftop.png) -->

ä»æˆªå›¾çš„ä¿¡æ¯ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å ç”¨èµ„æºæœ€å¤šçš„ä¸€äº›æ–¹æ³•ï¼ŒåŒ…æ‹¬ sysstress è¿›ç¨‹çš„å„ç§æ–¹æ³•(ä»å›¾ç‰‡ä¸­åŸºæœ¬ä¸Šå°±å¯ä»¥ç¡®å®šé«˜æ¶ˆè€—çš„æ–¹æ³•åœ¨å“ªé‡Œ)ä»¥åŠåº•å±‚çš„ `__vdso_clock_gettime`, é‚£å†ç»“åˆå‹æµ‹å·¥å…·çš„ä»£ç åˆ†æä¸‹:

``` golang
func burnCpu(wg *sync.WaitGroup, start time.Time, durSec int64) {
	defer wg.Done()
	for {
		_ = 1 * 1
		now := time.Now()
		if now.Sub(start) > time.Duration(durSec)*time.Second {
			break
		}
	}
}
```
è¿™æ˜¯æ–¹æ³•çš„æ ¸å¿ƒï¼Œå…¶å®å°±æ˜¯åšæ— æ„ä¹‰çš„è®¡ç®—ï¼Œå¤–åŠ æ—¶é—´çš„åˆ¤æ–­ï¼Œè¶…è¿‡ duration å°±ç»“æŸã€‚è¿™æ ·å’Œä¸Šé¢çš„ perf top ä¿¡æ¯å°±èƒ½å¯¹åº”èµ·æ¥ã€‚

ç„¶åæˆ‘ä»¬ç”¨ java å†™ä¸€ä¸ªåŒæ ·çš„ç¨‹åºï¼Œå†çœ‹çœ‹ `perf top`çš„æƒ…å†µ:
{% image /images/javaperftop.png perf top, fancybox:true %}
<!-- ![perf top](../images/javaperftop.png) -->
ä»è¿™ä¸€å¤§æ®µæ˜¾ç¤ºæ¥çœ‹ï¼Œæ˜¯ä¸æ˜¯çœ‹çš„ä¸€è„¸æ‡µé€¼ï¼Œå¾ˆéš¾å‘ç°åˆ°åº•æ˜¯ä»€ä¹ˆç¨‹åºåœ¨å ç”¨CPU èµ„æºã€‚å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹æºç¨‹åº:
``` java
import java.time.LocalDateTime;

public class Main {
    public static void main(String[] args) {
        int n = 10;

        for (int i = 0; i < 10; i++) {
            new Thread(new Runnable() {
                public void run() {
                    while (true) {
                        Math.sin(Math.random());
                        LocalDateTime currentTime = LocalDateTime.now();
                    }
                }
            }).start();
        }
    }
}
```
è¿™é‡Œçš„ç¨‹åºä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œå¯åŠ¨ 10 ä¸ªçº¿ç¨‹ï¼Œåšä¸€ä¸ªæ— æ„ä¹‰çš„æ•°å­¦è¿ç®—ï¼Œç„¶åè·å–å½“å‰æ—¶é—´ã€‚ä»è¿™æ®µä»£ç ä¸­æ˜¯ä¸æ˜¯å¾ˆéš¾å’Œä¸Šé¢`perf top`çš„æ˜¾ç¤ºå…³è”èµ·æ¥ï¼Ÿ åŸå› ä¹Ÿéå¸¸ç®€å•ï¼Œ åƒJava è¿™ç§é€šè¿‡ JVM æ¥è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè¿è¡Œå †æ ˆç”¨çš„éƒ½æ˜¯ JVM å†…ç½®çš„å‡½æ•°å’Œå †æ ˆç®¡ç†ã€‚æ‰€ä»¥ï¼Œä»ç³»ç»Ÿå±‚é¢åªèƒ½çœ‹åˆ° JVM çš„å‡½æ•°å †æ ˆï¼Œè€Œä¸èƒ½ç›´æ¥å¾—åˆ° Java åº”ç”¨ç¨‹åºçš„å †æ ˆã€‚é‚£æˆ‘ä»¬å¥½èƒ½é€šè¿‡ perf å»çœ‹åˆ° java ç›¸å…³çš„å †æ ˆå—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚

å¯ä»¥å€ŸåŠ© [perf-map-agent](https://github.com/jvm-profiling-tools/perf-map-agent) è¿™æ ·çš„å¼€æºå·¥å…·ï¼Œå»ç”Ÿæˆå’Œ`perf` å·¥å…·ä¸€èµ·ä½¿ç”¨çš„æ–¹æ³•æ˜ å°„ï¼Œä½†æ˜¯éœ€è¦åšé¢å¤–çš„ä¸€äº›é…ç½®ã€‚è¿™é‡Œçš„æ–¹æ³•å¤§å®¶å¯ä»¥è‡ªå·±æ¢ç©¶ï¼Œä¸ºä»€ä¹ˆä¸è¯¦ç»†çš„è®²è¿™ä¸ªå‘¢ï¼ŒåŸå› ä¹Ÿç®€å•ï¼Œæ’æŸ¥é—®é¢˜çš„å·¥å…·å¤šç§å¤šæ ·ï¼Œæ²¡å¿…è¦åœ¨ä¸€æ£µæ ‘ä¸ŠåŠæ­»ã€‚

#### jstack

æ—¢ç„¶ perf top å»æŸ¥çœ‹ JAVA çš„è°ƒç”¨æ ˆä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬å°±ç›´æ¥ä¸Š java æä¾›çš„ jstack å·¥å…·å»åˆ†æã€‚
- jstack -l pid > xxx.txt éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlinuxç³»ç»Ÿä¸­å¾€å¾€ä¼šç”¨ä¸åŒçš„ç”¨æˆ·å»æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œæ­¤æ—¶å¯èƒ½éœ€è¦é€šè¿‡sudu -u xxx jstackçš„å½¢å¼
- kill -3ï¼Œ jstack ç”¨ä¸äº†çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ kill -3 pid çš„å½¢å¼ï¼Œå †æ ˆé»˜è®¤ä¼šè¾“å‡ºåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­ï¼ˆæ ¹æ®ä¸åŒçš„é…ç½®ï¼Œä¿¡æ¯ä¹Ÿå¯èƒ½è¾“å‡ºåœ¨å…¶ä»–åœ°æ–¹ï¼Œæ¯”å¦‚è¿™ä¸ªç¨‹åºçš„æ—¥å¿—ä¸­ï¼‰ã€‚

å…·ä½“çš„æ“ä½œæ­¥éª¤:
1. `top -Hp $pid` æ‰¾åˆ°å ç”¨ CPU çš„å…·ä½“çº¿ç¨‹
2. `jstack -l $pid > /tmp/$pid.jstack` æˆ–è€… `kill -3 $pid`å°† java è¿›ç¨‹çš„å †æ ˆæƒ…å†µè¾“å‡ºçš„æ—¥å¿—ä¸­ï¼Œç„¶åæ ¹æ® `top -Hp` çœ‹åˆ°çš„çº¿ç¨‹ä¿¡æ¯åœ¨è¾“å‡ºçš„å †æ ˆæ—¥å¿—ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼ˆ`top -Hp` è¾“å‡ºçš„æ˜¯ 10 è¿›åˆ¶çš„ idï¼Œ`jstack` è¾“å‡ºçš„æ˜¯ 16 è¿›åˆ¶çš„ï¼Œåœ¨æŸ¥æ‰¾æ—¶æ³¨æ„è¿›åˆ¶è½¬æ¢ï¼‰

æˆ‘ä»¬çœ‹ä¸‹ä¸Šé¢ java ç¨‹åºçš„å †æ ˆçš„ä¿¡æ¯:
``` Lua
2024-08-16 15:15:40
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.221-b11 mixed mode):

"Attach Listener" #35 daemon prio=9 os_prio=0 tid=0x00007f52b4001000 nid=0x71f4 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"DestroyJavaVM" #34 prio=5 os_prio=0 tid=0x00007f53e0009800 nid=0x1693 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"Thread-1" #25 prio=5 os_prio=0 tid=0x00007f53e015a800 nid=0x16d9 runnable [0x00007f52f64e3000]
   java.lang.Thread.State: RUNNABLE
	at sun.misc.Unsafe.getObjectVolatile(Native Method)
	at java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:755)
	at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:938)
	at java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:267)
	at java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:227)
	at java.time.ZoneRegion.ofId(ZoneRegion.java:120)
	at java.time.ZoneId.of(ZoneId.java:411)
	at java.time.ZoneId.of(ZoneId.java:359)
	at java.time.ZoneId.of(ZoneId.java:315)
	at java.util.TimeZone.toZoneId(TimeZone.java:556)
	at java.time.ZoneId.systemDefault(ZoneId.java:274)
	at java.time.Clock.systemDefaultZone(Clock.java:178)
	at java.time.LocalDateTime.now(LocalDateTime.java:180)
	at Main$1.run(Main.java:12)
	at java.lang.Thread.run(Thread.java:748)

   Locked ownable synchronizers:
	- None

"Thread-0" #24 prio=5 os_prio=0 tid=0x00007f53e0159000 nid=0x16d8 runnable [0x00007f52f65e4000]
   java.lang.Thread.State: RUNNABLE
	at sun.misc.Unsafe.getObjectVolatile(Native Method)
	at java.util.concurrent.ConcurrentHashMap.tabAt(ConcurrentHashMap.java:755)
	at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:938)
	at java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:267)
	at java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:227)
	at java.time.ZoneRegion.ofId(ZoneRegion.java:120)
	at java.time.ZoneId.of(ZoneId.java:411)
	at java.time.ZoneId.of(ZoneId.java:359)
	at java.time.ZoneId.of(ZoneId.java:315)
	at java.util.TimeZone.toZoneId(TimeZone.java:556)
	at java.time.ZoneId.systemDefault(ZoneId.java:274)
	at java.time.Clock.systemDefaultZone(Clock.java:178)
	at java.time.LocalDateTime.now(LocalDateTime.java:180)
	at Main$1.run(Main.java:12)
	at java.lang.Thread.run(Thread.java:748)

   Locked ownable synchronizers:
	- None
 --- 10 ä¸ª thread

"Service Thread" #23 daemon prio=9 os_prio=0 tid=0x00007f53e0143800 nid=0x16d6 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"C2 CompilerThread1" #6 daemon prio=9 os_prio=0 tid=0x00007f53e010e000 nid=0x16c5 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None
 --- ä¸€å¤§å † C2 CompilerThread

"C2 CompilerThread0" #5 daemon prio=9 os_prio=0 tid=0x00007f53e010b000 nid=0x16c4 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"Signal Dispatcher" #4 daemon prio=9 os_prio=0 tid=0x00007f53e0109800 nid=0x16c3 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
	- None

"Finalizer" #3 daemon prio=8 os_prio=0 tid=0x00007f53e00d8800 nid=0x16c2 in Object.wait() [0x00007f52f7bfa000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on <0x000000008021a5e8> (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
	- locked <0x000000008021a5e8> (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)
	at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216)

   Locked ownable synchronizers:
	- None

"Reference Handler" #2 daemon prio=10 os_prio=0 tid=0x00007f53e00d3800 nid=0x16c1 in Object.wait() [0x00007f52f7cfb000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on <0x0000000080218d38> (a java.lang.ref.Reference$Lock)
	at java.lang.Object.wait(Object.java:502)
	at java.lang.ref.Reference.tryHandlePending(Reference.java:191)
	- locked <0x0000000080218d38> (a java.lang.ref.Reference$Lock)
	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)

   Locked ownable synchronizers:
	- None

"VM Thread" os_prio=0 tid=0x00007f53e00ca000 nid=0x16c0 runnable

"GC task thread#0 (ParallelGC)" os_prio=0 tid=0x00007f53e001f000 nid=0x1694 runnable

--- ä¸€å¤§å † GC task thread

"VM Periodic Task Thread" os_prio=0 tid=0x00007f53e0146000 nid=0x16d7 waiting on condition

JNI global references: 202
```
æˆ‘ä»¬é€šè¿‡ top -Hp çš„ä¿¡æ¯å°±å¯ä»¥å¿«é€Ÿå®šä½åˆ° Thread-[0-9] è¿™å‡ ä¸ªçº¿ç¨‹ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨æ ˆéƒ½æ˜¯ `java.time.LocalDateTime.now`, ä¹Ÿè¯´æ˜äº†è¿™ä¸ªæ–¹æ³•åœ¨ä¸åœæ¶ˆè€— CPUã€‚ï¼ˆä½†æ˜¯ jstack åªèƒ½æ•è·çŸ­æ—¶é—´æˆ–è€…ç¬æ—¶çš„å †æ ˆä¿¡æ¯ï¼Œæ²¡æ³•å¤„ç†é•¿æ—¶é—´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è·å–æ—¶å¯ä»¥å¤šæ‰“å°å‡ æ¬¡æˆ–è€…ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼‰

è‡³äº jstack çš„è¯¦ç»†ç”¨æ³•ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšå®¢ï¼š[javaé—®é¢˜å®šä½](https://baixiaozhou.github.io/2024/08/13/JAVA%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/)

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰éå¸¸å¤šçš„åˆ†æå·¥å…·ï¼Œpstack\gstack\strace\gdbç­‰ç­‰ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæ¢ç´¢ä½¿ç”¨

#### ç«ç„°å›¾

ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šæ“ä½œçš„å‘½ä»¤å’Œæ–¹æ³•ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ¯”è¾ƒç›´è§‚çš„æ–¹å¼èƒ½å¤Ÿç›´æ¥çœ‹åˆ°å„ç§æ–¹æ³•æ‰§è¡Œçš„è€—æ—¶æ¯”é‡ç­‰æƒ…å†µå‘¢ï¼Ÿç«ç„°å›¾å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µè€Œç”Ÿçš„ã€‚

ç«ç„°å›¾çš„åˆ†ç±»æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„åŒ…æ‹¬:
1. CPU ç«ç„°å›¾ (CPU Flame Graph)
	-	æè¿°ï¼šå±•ç¤º CPU åœ¨ä¸åŒæ–¹æ³•ä¸Šçš„æ¶ˆè€—æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨æ‰€å ç”¨çš„ CPU æ—¶é—´ã€‚
	-	ç”¨é€”ï¼šç”¨äºåˆ†æ CPU æ€§èƒ½ç“¶é¢ˆï¼Œè¯†åˆ«å“ªäº›æ–¹æ³•æ¶ˆè€—äº†æœ€å¤šçš„ CPU èµ„æºã€‚
	-	åº”ç”¨ï¼šJavaã€C++ ç­‰å¤šç§ç¼–ç¨‹è¯­è¨€çš„æ€§èƒ½åˆ†æã€‚
2. å†…å­˜ç«ç„°å›¾ (Memory Flame Graph)
	- æè¿°ï¼šå±•ç¤ºå†…å­˜åˆ†é…æƒ…å†µï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–¹æ³•è°ƒç”¨åˆ†é…çš„å†…å­˜é‡ã€‚
    - ç”¨é€”ï¼šç”¨äºæ£€æµ‹å†…å­˜æ³„æ¼ã€è¿‡åº¦å†…å­˜åˆ†é…é—®é¢˜ï¼Œå¸®åŠ©ä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚
	- åº”ç”¨ï¼šå¸¸ç”¨äºåˆ†æå†…å­˜å¯†é›†å‹åº”ç”¨ï¼Œå¦‚ Java åº”ç”¨çš„å †å†…å­˜åˆ†æã€‚
3. I/O ç«ç„°å›¾ (I/O Flame Graph)
	-	æè¿°ï¼šå±•ç¤º I/O æ“ä½œçš„è€—æ—¶æƒ…å†µï¼Œæ˜¾ç¤ºä¸åŒæ–¹æ³•çš„ I/O æ“ä½œå ç”¨çš„æ—¶é—´ã€‚
	-	ç”¨é€”ï¼šç”¨äºåˆ†æåº”ç”¨ç¨‹åºçš„ I/O æ€§èƒ½ï¼Œè¯†åˆ«æ…¢é€Ÿæˆ–é¢‘ç¹çš„ I/O æ“ä½œã€‚
	-	åº”ç”¨ï¼šæ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ç½‘ç»œé€šä¿¡ç­‰åœºæ™¯çš„æ€§èƒ½è°ƒä¼˜ã€‚

æˆ‘ä»¬è¿™é‡Œé€šè¿‡ [async-profiler](https://github.com/async-profiler/async-profiler) å¯¹æ–‡ç« ä¸Šé¢çš„javaå‹æµ‹ç¨‹åºè¿›è¡ŒæŠ“å–(è¿™ä¸ªå·¥å…·åªèƒ½æŠ“ java çš„, å¯¹äº golang ç¨‹åºï¼Œå¯ä»¥åˆ©ç”¨ golang æä¾›çš„ pprof)

```
tar -xzf async-profiler-3.0-linux-x64.tar.gz
cd async-profiler-3.0-linux-x64/bin
./asprof -d 60 pid -f /tmp/javastress.html
```
æˆ‘ä»¬ç”¨æµè§ˆå™¨æ‰“å¼€ç”Ÿæˆçš„ html æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ç«ç„°å›¾ä¿¡æ¯ï¼ˆå¯ä»¥åœ¨ç½‘é¡µè¿›è¡Œç‚¹å‡»ï¼ŒæŸ¥çœ‹æ›´ç»†èŠ‚çš„æ–¹æ³•ï¼‰
{% image /images/javafire.png java ç¨‹åºçš„ç«ç„°å›¾, fancybox:true %}
<!-- ![java ç¨‹åºçš„ç«ç„°å›¾](../images/javafire.png) -->

è¿™æ ·çœ‹èµ·æ¥å°±æ¯” jstackè¿™äº›ä¿¡æ¯æ›´åŠ ç›´è§‚ä¸€ç‚¹ã€‚

## è´Ÿè½½é£™å‡

### è´Ÿè½½çš„å®šä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹è´Ÿè½½

æˆ‘ä»¬å…ˆçœ‹ä¸‹ç³»ç»Ÿè´Ÿè½½çš„å®˜æ–¹æè¿°:
```
System load averages is the average number of processes that are either in a runnable or uninterruptable state. A process in arunnable state is either using the CPU or waiting to use the CPU.  A process in uninterruptable state is waiting for some I/O access,eg waiting for disk.  The averages are taken over the three time intervals.  Load averages are not normalized for the number of CPUs ina  system,  so a load average of 1 means a single CPU system is loaded all the time while on a 4 CPU system it means it was idle 75% of the time.
```

ç³»ç»Ÿè´Ÿè½½å¹³å‡å€¼è¡¨ç¤ºå¤„äºå¯è¿è¡Œæˆ–ä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹çš„å¹³å‡æ•°é‡ã€‚å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹è¦ä¹ˆæ­£åœ¨ä½¿ç”¨ CPUï¼Œè¦ä¹ˆæ­£åœ¨ç­‰å¾…ä½¿ç”¨ CPUã€‚å¤„äºä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸäº› I/O è®¿é—®ï¼Œä¾‹å¦‚ç­‰å¾…ç£ç›˜ã€‚è¿™é‡Œçš„æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯ loadavg è¿™ä¸ªæ•°å€¼ä½“ç°äº†æŸäº›ç‰¹å®šçŠ¶æ€è¿›ç¨‹çš„æ•°é‡ã€‚

é‚£å¼•ç”³å‡ºä¸¤ä¸ªé—®é¢˜:
1. è¿›ç¨‹çš„çŠ¶æ€æœ‰å“ªäº›ï¼Ÿ å¦‚ä½•åœ¨ Linux ä¸ŠæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
2. å¯è¿è¡Œå’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆ

æŸ¥çœ‹çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ps å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œæ¯”å¦‚é€šè¿‡`ps -auxf`, æˆ‘ä¹ˆå¯ä»¥çœ‹åˆ°æœ‰ä¸€åˆ—ä¸º `STAT`,è¿™åˆ—å°±ä»£è¡¨è¯¥è¿›ç¨‹çš„çŠ¶æ€:

{% image /images/psauxf.png è¿›ç¨‹çŠ¶æ€ fancybox:true %}

è¿›ç¨‹çš„çŠ¶æ€å’Œå…·ä½“å«ä¹‰:
- D    uninterruptible sleep (usually IO)
- R    running or runnable (on run queue)
- S    interruptible sleep (waiting for an event to complete)
- T    stopped by job control signal
- t    stopped by debugger during the tracing
- W    paging (not valid since the 2.6.xx kernel)
- X    dead (should never be seen) 
- Z    defunct ("zombie") process, terminated but not reaped by its parent

è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å¤„äºä¸å¯ä¸­æ–­çš„çŠ¶æ€çš„è¿›ç¨‹å’Œæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åˆ†åˆ«ä¸º `D` å’Œ `R`,æ¢ä¸ªè¯´æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´é€ æˆè´Ÿè½½å‡é«˜çš„åŸå› ä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªçŠ¶æ€çš„è¿›ç¨‹å¼•èµ·çš„ã€‚

ï¼ˆæ’ä¸ªé¢˜å¤–è¯ï¼ŒæŒ‰ç…§å®˜æ–¹çš„è¯´æ³•ï¼ŒX çŠ¶æ€çš„è¿›ç¨‹åº”è¯¥æ˜¯ä¸åº”è¯¥è¢«çœ‹åˆ°çš„ï¼Œ ä½†æ˜¯ä¹‹å‰åœ¨è…¾è®¯äº‘åšESçš„æ—¶å€™ï¼Œå¶ç„¶é—´ç¢°åˆ°äº†ä¸€æ¬¡ï¼Œå½“æ—¶è¿˜æˆªäº†ä¸ªå›¾ç”¨åšç•™å¿µğŸ˜‚ï¼Œä½†æ˜¯æ²¡æœ‰æ•è·åˆ°å…·ä½“çš„ä¿¡æ¯ï¼‰

è´Ÿè½½çš„æŒ‡æ ‡å¯ä»¥é€šè¿‡ `top` ä»¥åŠ `uptime` æŒ‡ä»¤è·å–
```
23:35:00 up 1 day, 46 min,  1 user,  load average: 49.16, 18.35, 7.87
```
è¿™é‡Œå±•ç¤ºäº† loadavg çš„ä¸‰ä¸ªæ•°å€¼: åˆ†åˆ«ä»£è¡¨çš„å«ä¹‰æ˜¯ 1minã€5minã€15min çš„ç³»ç»Ÿå¹³å‡è´Ÿè½½

é‚£æˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ç³»ç»Ÿçš„è´Ÿè½½æ˜¯é«˜æ˜¯ä½å‘¢ï¼Ÿ

è¿™é‡Œä¸€èˆ¬æœ‰ä¸ªç»éªŒå€¼ï¼Œæˆ‘ä»¬ä¸€èˆ¬å’Œ CPU å’Œæ ¸å¿ƒæ•°è¿›è¡Œå¯¹æ¯”ï¼Œä¸€èˆ¬è´Ÿè½½åœ¨ CPU æ ¸å¿ƒçš„ 70% å·¦å³ä»¥åŠä»¥ä¸‹ï¼Œå¯¹ç³»ç»Ÿä¸€èˆ¬æ²¡ä»€ä¹ˆå½±å“ï¼Œè¶…è¿‡ 70%ï¼Œç³»ç»Ÿå¯èƒ½æ”¶åˆ°å½±å“ã€‚ä½†æ˜¯è¿™é‡Œè¿˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œè´Ÿè½½çš„æ¯”ä¾‹åœ¨ 70% ä»¥ä¸‹æ—¶ä¸ä¸€å®šä»£è¡¨ç³»ç»Ÿå°±æ²¡é—®é¢˜ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿä¸ŠåŸºæœ¬ä¸Šæ²¡æœ‰ä¸šåŠ¡åœ¨è¿è¡Œï¼Œé‚£ä¹ˆè´Ÿè½½åŸºæœ¬ä¸Šå°±åœ¨é›¶ç‚¹å‡ å·¦å³ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œè´Ÿè½½æœ‰å‡é«˜ä¸ä¸€å®šæ˜¯åˆç†çš„ï¼ˆåé¢ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼‰

### å¦‚ä½•è®©ç³»ç»Ÿè´Ÿè½½é£™é«˜

#### çº¯è®¡ç®—ä»»åŠ¡å¯¹è´Ÿè½½çš„å½±å“

æ—¢ç„¶è¯´æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¼šå¼•èµ·è´Ÿè½½çš„å˜åŒ–ï¼Œé‚£ä¹ˆè·‘ä¸€äº›ç¨‹åºï¼Œè®©ç¨‹åºä¸åœè¿è¡Œï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶å°±èƒ½æ„é€ å‡ºæŒç»­è¿è¡Œçš„è¿›ç¨‹äº†ã€‚
æˆ‘è¿™é‡Œæ‰¾äº†ä¸‰å°æœºå™¨(64C)ï¼Œç”¨æˆ‘çš„å‹æµ‹å·¥å…·å…ˆè·‘ä¸€äº›çº¯ CPU çš„è¿ç®—ï¼Œç„¶åè§‚å¯Ÿä¸‹æ•ˆæœï¼š

æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹:
1. 10 å¹¶å‘ 30min
   -  `nohup ./sysstress cpu --cpu-number 10 --duration 30m > /dev/null 2>&1`
2. 30 å¹¶å‘ 30min
   - `nohup ./sysstress cpu --cpu-number 30 --duration 30m > /dev/null 2>&1`
3. 60 å¹¶å‘ 30min
   - `nohup ./sysstress cpu --cpu-number 60 --duration 30m > /dev/null 2>&1`

æ•ˆæœå¦‚ä¸‹:
{% image /images/load10.png 10å¹¶å‘è´Ÿè½½, fancybox:true %}
{% image /images/load30.png 30å¹¶å‘è´Ÿè½½, fancybox:true %}
{% image /images/load60.png 60å¹¶å‘è´Ÿè½½, fancybox:true %}
<!-- ![10å¹¶å‘è´Ÿè½½](../images/load10.png)
![30å¹¶å‘è´Ÿè½½](../images/load30.png)
![60å¹¶å‘è´Ÿè½½](../images/load60.png) -->

ä»ä¸Šè¿°æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨çº¯è¿ç®—è¿™ç§åœºæ™¯ä¸‹ï¼Œå¹¶å‘çš„é‡åŸºæœ¬ä¸Šå’Œè´Ÿè½½æ˜¯å¯¹åº”çš„ã€‚ä¹Ÿå°±æ˜¯è¯´éšç€ CPUçš„ä½¿ç”¨é‡ ä¸Šæ¶¨ï¼Œè´Ÿè½½ä¹Ÿä¼šä¸æ–­å˜é«˜ã€‚

#### ç£ç›˜ IO å¯¹è´Ÿè½½çš„å½±å“

åœ¨åˆšæ‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†çº¯è¿ç®—å¯¹è´Ÿè½½çš„å½±å“ï¼ˆR è¿›ç¨‹çš„ä»£è¡¨ï¼‰ï¼Œç„¶ååœ¨å…³äº D è¿›ç¨‹çš„è¯´æ˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„è¯´æ˜ `(usually IO)` ,å³é€šå¸¸æ˜¯ IO å¼•èµ·çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ç£ç›˜ IO æ¥æµ‹è¯•ä¸€ä¸‹

æµ‹è¯•åˆ†ä¸ºä¸‰ç»„ï¼Œæµ‹è¯•å‰å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œè¿›ç¨‹:
1. 10 å¹¶å‘ 15min
   - `nohup ./sysstress io --operation read --filepath test.access.log -p 10 -d 15m > /dev/null 2>&1 &`
2. 30 å¹¶å‘ 15min
   - `nohup ./sysstress io --operation read --filepath test.access.log -p 30 -d 15m > /dev/null 2>&1 &`
3. 60 å¹¶å‘ 15min
   - `nohup ./sysstress io --operation read --filepath test.access.log -p 60 -d 15m > /dev/null 2>&1 &`

æ•ˆæœå¦‚ä¸‹:

{% image /images/ioload10.png 10å¹¶å‘è´Ÿè½½ fancybox:true %}
{% image /images/ioload30.png 30å¹¶å‘è´Ÿè½½ fancybox:true %}
{% image /images/ioload60.png 60å¹¶å‘è´Ÿè½½ fancybox:true %}

æˆ‘ä»¬ä¹Ÿé¡ºä¾¿çœ‹ä¸€ä¸‹ï¼Œ60 å¹¶å‘ä¸‹ CPU çš„æƒ…å†µ:

{% image /images/io60c.png 60å¹¶å‘ç³»ç»Ÿæ•´ä½“æƒ…å†µ fancybox:true %}

è¿™é‡Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œç³»ç»Ÿçš„ CPU åŸºæœ¬ä¸Šå·²ç»è·‘æ»¡äº†ã€‚us å’Œ sy éƒ½å çš„æ¯”è¾ƒå¤šï¼Œä½†æ˜¯è¿™ç§è¯»å–éå¸¸æœ‰å¯èƒ½èµ°åˆ°ç¼“å­˜ä¸­ï¼Œæˆ‘ä»¬æƒ³æµ‹ç»•è¿‡ç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡ DIRECT çš„æ–¹å¼ã€‚

ä½†æ˜¯ä¸Šé¢çš„ä¾‹å­å…¶å®ä¹Ÿè¯æ˜äº†ä¸€ä»¶äº‹ï¼ŒIO çš„æ“ä½œä¹Ÿæ˜¯ä¼šå¯¼è‡´è´Ÿè½½äº§ç”Ÿé£™å‡ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç£ç›˜IO å’Œ CPU æ“ä½œéƒ½ä¼šå¯¼è‡´ç³»ç»Ÿè´Ÿè½½é£™å‡ï¼Œé‚£ä¹ˆè´Ÿè½½é£™å‡ä¸€å®šä¼šæ˜¯è¿™ä¸¤ä¸ªåŸå› å—ï¼Ÿç­”æ¡ˆä¹Ÿæ˜¯æœªå¿…çš„ï¼Œå› ä¸ºä¸Šè¿°æˆ‘ä»¬æ›¾ç»æåˆ°è¿‡ D çŠ¶æ€çš„è¿›ç¨‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å¥½åƒè¿˜æ²¡ä»‹ç»è¿‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç»§ç»­æ¨¡æ‹Ÿï¼Œæ—¢ç„¶ D çŠ¶æ€çš„è¿›ç¨‹æ˜¯ IO æ“ä½œå¼•èµ·çš„ï¼Œæ™®é€šçš„ç£ç›˜è¯»å†™ IO å¾ˆéš¾æ¨¡æ‹Ÿï¼Œé‚£æˆ‘ä»¬å°±æ¢ä¸ª IO åœºæ™¯ç»§ç»­æ¨¡æ‹Ÿ -- ç½‘ç»œ IOã€‚

#### é€šè¿‡ç½‘ç»œ IO æ¨¡æ‹Ÿ D çŠ¶æ€è¿›ç¨‹è§‚å¯Ÿè´Ÿè½½å½±å“

è¿™é‡Œç›´æ¥ä¸Šä¸€ä¸ªæ¨¡æ‹Ÿæ–¹æ³•:
- A æœºå™¨å¼€å¯ NFS Server
- B æœºå™¨ä½œä¸ºå®¢æˆ·ç«¯è¿›è¡ŒæŒ‚è½½
- æ–­å¼€ç½‘ç»œ
- ç–¯ç‹‚ df -h

è¯¦ç»†çš„æ“ä½œæ­¥éª¤:
```
# å®‰è£… Centos
sudo yum install nfs-utils

# æœåŠ¡ç«¯é…ç½®
sudo mkdir -p /mnt/nfs_share
sudo chown nobody:nogroup /mnt/nfs_share
sudo chmod 755 /mnt/nfs_share
## æ‰“å¼€ /etc/exports é…ç½®ï¼Œæ·»åŠ ä¸€è¡Œæ¥å®šä¹‰å…±äº«ç›®å½•åŠå…¶æƒé™ã€‚ä¾‹å¦‚ï¼Œå°† /mnt/nfs_share å…±äº«ç»™ç½‘ç»œ 192.168.1.0/24ï¼Œå¹¶æä¾›è¯»å†™æƒé™ï¼š
/mnt/nfs_share 192.168.1.0/24(rw,sync,no_subtree_check)

## å¯åŠ¨ NFS
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
sudo systemctl enable nfs-kernel-server

# å®¢æˆ·ç«¯é…ç½®
sudo mkdir -p /mnt/nfs_client
sudo mount -t nfs 192.168.1.100(server ip):/mnt/nfs_share /mnt/nfs_client
## éªŒè¯
df -h /mnt/nfs_client

# æ–­ç½‘æ¨¡æ‹Ÿ(å®¢æˆ·ç«¯)
iptables -I INPUT -s serverip -j DROP

# æŒç»­(ç–¯ç‹‚)æ‰§è¡Œï¼š
du -sh /mnt/nfs_client
```
å› ä¸ºç½‘ç»œå·²ç»æ–­æ‰ï¼Œæ‰€ä»¥`du -sh /mnt/nfs_client`,è€Œä¸”è¿™ä¸ªç¨‹åºæ²¡æœ‰è‡ªåŠ¨é€€å‡ºæˆ–è€…æŠ¥é”™ï¼Œè¿™æ ·å°±å¯¼è‡´ç¨‹åºæ— æ³•é¡ºåˆ©æ‰§è¡Œä¸‹å»ï¼Œç»§è€Œé˜»å¡ä½å°±å˜æˆäº† D çŠ¶æ€çš„è¿›ç¨‹ã€‚

åŸºäºè¿™ç§æ¨¡æ‹Ÿæ–¹æ³•å¤§å®¶å¯ä»¥è‡ªè¡Œæµ‹è¯•ä¸‹ï¼Œç¬”è€…ä¹‹å‰åšè¿‡ä¸€ä¸ªåœºæ™¯ï¼Œå°†ä¸€ä¸ªä¸¤æ ¸å¿ƒçš„ CPUè´Ÿè½½å¹²åˆ°äº† 200 å¤šï¼Œä½†æ˜¯å› ä¸º**è¿™ç§æƒ…å†µä¸‹æ›´å¤šæ˜¯é˜»å¡åœ¨ç½‘ç»œä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶çš„è´Ÿè½½è™½é«˜ï¼Œå¹¶ä¸ä¸€å®šå½±å“ç³»ç»Ÿè¿è¡Œ**ã€‚

å½“ç„¶è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªä¾‹å­ï¼Œç¬”è€…æ›¾ç»ä¹Ÿå› ä¸ºè§è¿‡ ping æ“ä½œé˜»å¡å¯¼è‡´çš„è´Ÿè½½é£™å‡ï¼Œæ‰€ä»¥è¿™ç§åœºæ™¯æ˜¯å¤šç§å¤šæ ·çš„ğŸ˜‚ï¼Œå¤§å®¶æœ‰æ›´å¤šçš„ä¾‹å­ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ï¼Œå…±åŒå­¦ä¹ è¿›æ­¥ã€‚


### è´Ÿè½½é£™å‡å¦‚ä½•æ’æŸ¥
åŸºäºä¸Šé¢çš„ä¾‹å­å’Œåœºæ™¯æ¨¡æ‹Ÿï¼Œæˆ‘ä»¬å…¶å®åº”è¯¥å·²ç»æœ‰ä¸€å¥—åŸºæœ¬çš„æ’æŸ¥æ–¹æ³•äº†ï¼Œä¸‹é¢è¿™å¼ å›¾æ˜¯æˆ‘ä¸ªäººçš„ä¸€äº›æ€»ç»“(å›¾è¿˜ä¼šä¸æ–­å®Œå–„)

{% image /images/loadhigh.png  è´Ÿè½½é«˜æ’æŸ¥å¯¼å›¾ fancybox:true %}

## å†…å­˜å ç”¨è¿‡é«˜

æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹æœ‰å“ªäº›å¸¸ç”¨çš„å†…å­˜æ€§èƒ½å·¥å…·:
| å·¥å…·   | åŠŸèƒ½                                    | ç”¨æ³•                    | å¸¸ç”¨é€‰é¡¹                           |
|--------|-----------------------------------------|-------------------------|-----------------------------------|
| `free` | æ˜¾ç¤ºç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨æƒ…å†µ                  | `free -h`               | `-h`ï¼šä»¥äººç±»å¯è¯»çš„æ ¼å¼æ˜¾ç¤º          |
| `top`  | å®æ—¶æ˜¾ç¤ºç³»ç»Ÿçš„è¿›ç¨‹å’Œå†…å­˜ä½¿ç”¨æƒ…å†µ        | `top`                   | æ—                                  |
| `htop` | æä¾›æ›´å‹å¥½çš„ç”¨æˆ·ç•Œé¢çš„è¿›ç¨‹ç›‘æ§å·¥å…·      | `htop`                  | æ—                                  |
| `vmstat`| æŠ¥å‘Šè™šæ‹Ÿå†…å­˜ã€è¿›ç¨‹ã€CPU æ´»åŠ¨ç­‰ç»Ÿè®¡ä¿¡æ¯  | `vmstat 1`              | `1`ï¼šæ¯ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®              |
| `ps`   | æŸ¥çœ‹ç³»ç»Ÿä¸­è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µ            | `ps aux --sort=-%mem`   | `aux`ï¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„è¿›ç¨‹ï¼Œ `--sort=-%mem`ï¼šæŒ‰å†…å­˜ä½¿ç”¨é‡é™åºæ’åˆ— |
| `pmap` | æ˜¾ç¤ºè¿›ç¨‹çš„å†…å­˜æ˜ å°„                      | `pmap -x <pid>`         | `-x`ï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯                |
| `smem` | æä¾›è¯¦ç»†çš„å†…å­˜ä½¿ç”¨æŠ¥å‘Š                  | `smem -r`               | æ—                                  |
| `/proc`| æä¾›ç³»ç»Ÿå’Œè¿›ç¨‹çš„è¯¦ç»†å†…å­˜ä¿¡æ¯            | `cat /proc/meminfo`<br>`cat /proc/<pid>/status` | æ—                                  |

### å¦‚ä½•åˆ¤æ–­å†…å­˜å ç”¨è¿‡é«˜

ç³»ç»Ÿå†…å­˜çš„ä½¿ç”¨æƒ…å†µå¯ä»¥é€šè¿‡ `top` ä»¥åŠ `free` å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œä»¥ `free -m`ä¸ºä¾‹:

{% image /images/free.png  freeæŸ¥çœ‹å†…å­˜ä¿¡æ¯ fancybox:true %}

å­—æ®µè¯´æ˜ï¼š
- total:  ç³»ç»Ÿæ€»å†…å­˜ï¼ˆRAMï¼‰æˆ–äº¤æ¢ç©ºé—´ï¼ˆSwapï¼‰çš„æ€»é‡ã€‚
- used:   å·²ç”¨å†…å­˜æˆ–äº¤æ¢ç©ºé—´çš„é‡ã€‚è¿™åŒ…æ‹¬æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä»¥åŠç³»ç»Ÿç¼“å­˜ï¼ˆå¯¹äºå†…å­˜ï¼‰æˆ–å·²ç»ä½¿ç”¨çš„äº¤æ¢ç©ºé—´ã€‚
- free:   ç©ºé—²çš„å†…å­˜æˆ–äº¤æ¢ç©ºé—´çš„é‡ã€‚è¡¨ç¤ºå½“å‰æœªè¢«ä»»ä½•è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜æˆ–äº¤æ¢ç©ºé—´ã€‚
- shared: è¢«å¤šä¸ªè¿›ç¨‹å…±äº«çš„å†…å­˜é‡ï¼ˆå¯¹äºå†…å­˜ï¼‰ã€‚é€šå¸¸æ˜¯å…±äº«åº“å’Œè¿›ç¨‹é—´é€šä¿¡çš„å†…å­˜ã€‚
- buff/cache: ç”¨ä½œæ–‡ä»¶ç³»ç»Ÿç¼“å­˜å’Œç¼“å†²åŒºçš„å†…å­˜é‡ã€‚è¿™åŒ…æ‹¬ç¼“å­˜çš„æ–‡ä»¶æ•°æ®ï¼ˆcacheï¼‰å’Œç¼“å†²åŒºï¼ˆbuffï¼‰ã€‚è¿™äº›å†…å­˜å¯ä»¥è¢«ç³»ç»Ÿç”¨ä½œå…¶ä»–ç”¨é€”ã€‚
- available: å¯ä»¥åˆ†é…ç»™æ–°å¯åŠ¨çš„åº”ç”¨ç¨‹åºçš„å†…å­˜é‡ï¼Œè€Œä¸éœ€è¦äº¤æ¢åˆ°ç£ç›˜ã€‚è¿™ä¸ªæ•°å­—æ›´èƒ½åæ˜ ç³»ç»Ÿçš„å®é™…å¯ç”¨å†…å­˜

è¿™é‡Œæˆ‘ä»¬éœ€è¦å…³æ³¨ä¸‹ï¼Œä¸€èˆ¬å¯ç”¨å†…å­˜æˆ‘ä»¬å°±æ˜¯ä»¥ available ä¸ºå‡†ã€‚å½“ available çš„æŒ‡æ ‡è¶Šæ¥è¶Šå°æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦å…³æ³¨ç³»ç»Ÿå†…å­˜çš„æ•´ä½“ä½¿ç”¨æƒ…å†µã€‚

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦å…³æ³¨çš„ç‚¹ï¼šSwapï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¯¦ç»†ä»‹ç»:
```
Swap space in Linux is used when the amount of physical memory (RAM) is full. If the system 
needs more memory resources and the RAM is full, inactive pages in memory are moved to the 
swap space. While swap space can help machines with a small amount of RAM, it should not be 
considered a replacement for more RAM. Swap space is located on hard drives, which have a 
slower access time than physical memory.Swap space can be a dedicated swap partition (recommended),
 a swap file, or a combination of swap partitions and swap files.
```

SWAPæ„æ€æ˜¯äº¤æ¢ï¼Œé¡¾åæ€ä¹‰ï¼Œå½“æŸè¿›ç¨‹å‘OSè¯·æ±‚å†…å­˜å‘ç°ä¸è¶³æ—¶ï¼ŒOSä¼šæŠŠå†…å­˜ä¸­æš‚æ—¶ä¸ç”¨çš„æ•°æ®äº¤æ¢å‡ºå»ï¼Œæ”¾åœ¨SWAPåˆ†åŒºä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºSWAP OUTã€‚å½“æŸè¿›ç¨‹åˆéœ€è¦è¿™äº›æ•°æ®ä¸”OSå‘ç°è¿˜æœ‰ç©ºé—²ç‰©ç†å†…å­˜æ—¶ï¼Œåˆä¼šæŠŠSWAPåˆ†åŒºä¸­çš„æ•°æ®äº¤æ¢å›ç‰©ç†å†…å­˜ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºSWAP INã€‚
ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼ŒæŠŠç£ç›˜ç©ºé—´å½“ä½œ swap åˆ†åŒºï¼Œè§£å†³å®¹é‡ä¸è¶³çš„é—®é¢˜ã€‚

è¿™é‡Œæˆ‘ä»¬å…¶å®ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œç‰©ç†å†…å­˜çš„è¯»å†™æ€§èƒ½è‚¯å®šè¦æ¯”ç£ç›˜å¼ºä¸å°‘ï¼Œä½¿ç”¨äº†ç£ç›˜ç©ºé—´ä½œä¸ºå†…å­˜å­˜å‚¨ï¼Œæœ¬èº«è¯»å†™çš„æ€§èƒ½å°±ä¸é«˜ï¼Œè¿˜æ¶‰åŠåˆ°é¢‘ç¹çš„äº¤æ¢ï¼Œåè€Œå¢åŠ äº†ç³»ç»Ÿçš„è´Ÿè½½ï¼Œæ‰€ä»¥åœ¨çº¿ä¸Šç¯å¢ƒä¸­æˆ‘ä»¬ä¸€èˆ¬å»ºè®®å…³é—­ swapï¼Œå…·ä½“çš„å…³é—­æ–¹æ³•è¯·è‡ªè¡Œç™¾åº¦ã€‚

### å¦‚ä½•å®šä½å†…å­˜å ç”¨é«˜

é’ˆå¯¹å†…å­˜çš„å ç”¨ï¼Œå¸¸è§„æƒ…å†µä¸‹(å½“ç„¶ä¹Ÿæœ‰éå¸¸è§„æƒ…å†µ)ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å ç”¨å†…å­˜é«˜çš„å…·ä½“è¿›ç¨‹ï¼Œè¯¦ç»†çš„æ“ä½œæ–¹å¼æ˜¯:
`top`çš„æ—¶å€™è¾“å…¥`M`è¿›è¡Œæ’åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­è¿›ç¨‹æ¶ˆè€—å†…å­˜çš„è¯¦ç»†å æ¯”äº†:

{% image /images/top-process.png fancybox:true %}

è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸¤åˆ—: `%MEM` å’Œ `RES`, å‰è€…æ˜¯è¿™ä¸ªè¿›ç¨‹å ç”¨ç³»ç»Ÿå†…å­˜çš„ç™¾åˆ†æ¯”ï¼Œåè€…æ˜¯å ç”¨å®é™…å†…å­˜çš„å¤§å°ã€‚

æˆ‘ä»¬è¿˜æ˜¯ä»¥ JAVA å’Œ GOLANG ç¨‹åºä¸ºä¾‹æ¥åˆ†æå†…å­˜é«˜è¯¥å¦‚ä½•æ’æŸ¥

#### JAVA å ç”¨å†…å­˜è¿‡é«˜
Java åº”ç”¨çš„å†…å­˜ç®¡ç†ä¾èµ–äº JVM (Java Virtual Machine)ï¼Œé€šå¸¸ä¼šæ¶‰åŠåˆ°å †å†…å­˜ï¼ˆHeapï¼‰ã€éå †å†…å­˜ï¼ˆNon-Heapï¼‰ä»¥åŠæœ¬åœ°å†…å­˜ï¼ˆNative Memoryï¼‰ã€‚

##### å †å†…å†…å­˜åˆ†æ
1. æŸ¥çœ‹ JVM å¯åŠ¨å‚æ•°ï¼Œå°¤å…¶æ˜¯ -Xms å’Œ -Xmx é€‰é¡¹ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«è®¾ç½®äº†åˆå§‹å †å†…å­˜å¤§å°å’Œæœ€å¤§å †å†…å­˜å¤§å°ã€‚å¯ä»¥é€šè¿‡ ps å‘½ä»¤æŸ¥çœ‹è¿™äº›å‚æ•°ï¼š`ps -auxf | grep ç¨‹åºåç§°`
2. ä½¿ç”¨ jstat æŸ¥çœ‹ gc æƒ…å†µ, å®ä¾‹ï¼š`jstat -gc pid 1000`
{% image /images/gc.png gc ä¿¡æ¯ fancybox:true %}
å¦‚æœ GC é¢‘ç¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥è¿›è¡Œåˆ†æ
3. é€šè¿‡ jmap ç”Ÿæˆè¿›ç¨‹çš„å †å†…å­˜å¿«ç…§ (åœ¨ JVMå¯åŠ¨æ—¶ï¼Œå»ºè®®æ·»åŠ  OOM æ—¶è‡ªåŠ¨ç”Ÿæˆ heap dump: `-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/path/to/dumpfile`)ï¼š
``` bash
jmap -dump:live,format=b,file=heapdump.hprof <pid>
```
4. æ‹¿åˆ°å¿«ç…§æ–‡ä»¶åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ MAT æˆ–è€… Jprofiler è¿™æ ·çš„å·¥å…·å»å…·ä½“åˆ†æ
ä»¥ MAT ä¸ºä¾‹ï¼š

{% image /images/mat.jpeg MAT åˆ†æ JAVAå†…å­˜ fancybox:true %}

##### æœ¬åœ°å†…å­˜åˆ†æ

NMTï¼ˆNative Memory Trackingï¼‰æ˜¯ HotSpot JVM å¼•å…¥çš„è·Ÿè¸ª JVM å†…éƒ¨ä½¿ç”¨çš„æœ¬åœ°å†…å­˜çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå¯ä»¥é€šè¿‡ jcmd å·¥å…·è®¿é—® NMT æ•°æ®ã€‚NMT ç›®å‰ä¸æ”¯æŒè·Ÿè¸ªç¬¬ä¸‰æ–¹æœ¬åœ°ä»£ç çš„å†…å­˜åˆ†é…å’Œ JDK ç±»åº“ã€‚
NMT ä¸è·Ÿè¸ªé JVM ä»£ç çš„å†…å­˜åˆ†é…ï¼Œæœ¬åœ°ä»£ç é‡Œçš„å†…å­˜æ³„éœ²éœ€è¦ä½¿ç”¨æ“ä½œç³»ç»Ÿæ”¯æŒçš„å·¥å…·æ¥å®šä½ã€‚

å¯ç”¨ NMT ä¼šå¸¦æ¥ 5-10% çš„æ€§èƒ½æŸå¤±ã€‚NMT çš„å†…å­˜ä½¿ç”¨ç‡æƒ…å†µéœ€è¦æ·»åŠ ä¸¤ä¸ªæœºå™¨å­— word åˆ° malloc å†…å­˜çš„ malloc å¤´é‡Œã€‚NMT å†…å­˜ä½¿ç”¨ç‡ä¹Ÿè¢« NMT è·Ÿè¸ªã€‚
å¯åŠ¨å‘½ä»¤ï¼š `-XX:NativeMemoryTracking=[off | summary | detail]`ã€‚
- offï¼šNMT é»˜è®¤æ˜¯å…³é—­çš„ï¼›
- summaryï¼šåªæ”¶é›†å­ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨çš„æ€»è®¡æ•°æ®ï¼›
- detailï¼šæ”¶é›†æ¯ä¸ªè°ƒç”¨ç‚¹çš„å†…å­˜ä½¿ç”¨æ•°æ®ã€‚

å¼€å¯åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è®¿é—® NMT å†…å­˜ï¼š
```
jcmd <pid> VM.native_memory [summary | detail | baseline | summary.diff | detail.diff | shutdown] [scale= KB | MB | GB]
```

##### å…¶ä»–éå †å†…å­˜
ä¸»è¦åŒ…æ‹¬ï¼š
- JVM è‡ªèº«è¿è¡Œå ç”¨çš„ç©ºé—´ï¼›
- çº¿ç¨‹æ ˆåˆ†é…å ç”¨çš„ç³»ç»Ÿå†…å­˜ï¼›
- DirectByteBuffer å ç”¨çš„å†…å­˜ï¼›
- JNI é‡Œåˆ†é…çš„å†…å­˜ï¼›
- Java 8 å¼€å§‹çš„å…ƒæ•°æ®ç©ºé—´ï¼›
- NIO ç¼“å­˜
- Unsafe è°ƒç”¨åˆ†é…çš„å†…å­˜ï¼›
- codecache

å¯¹äºè¿™äº›é—®é¢˜ï¼Œé‡åˆ°å†…å­˜å‡é«˜çš„æƒ…å†µè¾ƒå°‘ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰è¿›è¡Œè¿‡è¯¦ç»†çš„æ’æŸ¥ï¼Œå¦‚æœæœ‰è¯»è€…æœ‹å‹æœ‰åšè¿‡ç±»ä¼¼çš„æ’æŸ¥ï¼Œå¯ä»¥åœ¨ä¸‹é¢ç•™è¨€è®¨è®ºã€‚

#### golangç¨‹åºå ç”¨å†…å­˜é«˜

golang å†…ç½®äº† pprof æ€§èƒ½åˆ†æå·¥å…·ï¼Œæ”¯æŒ CPUã€å†…å­˜ï¼ˆHeapï¼‰ã€æ ˆã€åç¨‹ç­‰çš„åˆ†æã€‚å¯ä»¥é€šè¿‡ HTTP æœåŠ¡æš´éœ² pprof æ¥å£ï¼Œå¹¶ä½¿ç”¨æµè§ˆå™¨æˆ– go tool pprof è¿›è¡Œåˆ†æï¼š
åœ¨ä»£ç ä¸­å¼•å…¥ net/http/pprof åŒ…ï¼š
```golang
import _ "net/http/pprof"

func main() {
    go func() {
        log.Println(http.ListenAndServe("localhost:6060", nil))
    }()
    // ä½ çš„åº”ç”¨ä»£ç 
}
```
å¯åŠ¨åº”ç”¨åï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—® `http://localhost:6060/debug/pprof/heap` ä¸‹è½½å †å†…å­˜å¿«ç…§ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ†æï¼š
```bash
go tool pprof -http=:8080 heap.prof
```
è¿™å°†å¯åŠ¨ä¸€ä¸ª Web ç•Œé¢ï¼Œä¾›ä½ åˆ†æå†…å­˜å ç”¨çš„çƒ­ç‚¹ã€‚
å…·ä½“çš„ä½¿ç”¨æ–¹å¼å¤§å®¶å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚

#### åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿå ç”¨

åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬è¯´äº†å¸¸è§„æƒ…å†µä¸‹çš„æ’æŸ¥ï¼Œé‚£æ¥ä¸ªéå¸¸è§„çš„ï¼Œå…ˆä¸Šå¼ å›¾ï¼š

{% image /images/tmp-mem.png å†…å­˜å ç”¨æ¨¡æ‹Ÿ fancybox:true %}

è¿™é‡Œå¤§å®¶çœ‹çœ‹åˆ°ï¼Œå†…å­˜æ€»é‡å¤§æ¦‚æœ‰ 250 ä¸ª Gï¼Œå¯ç”¨å†…å­˜åªæœ‰ 126Gï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡ top çœ‹å†…å­˜å æ¯”è·Ÿå®é™…çš„æ•°å€¼ç›¸å·®ç”šè¿œã€‚

è¿™ç§åœºæ™¯æ˜¯ä¸æ˜¯éå¸¸å¥‡æ€ªå‘¢ï¼Ÿæ²¡æœ‰è¿›ç¨‹å ç”¨å†…å­˜ï¼Œä½†æ˜¯å†…å­˜è¢«æ¶ˆè€—äº†ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¾ˆæœ‰å¯èƒ½è·ŸåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿæœ‰å…³ã€‚

è¿™é‡Œæˆ‘è¯´ä¸€ä¸‹æ¨¡æ‹Ÿæ–¹æ³•:
```
# systemd çš„åŒ…ä¸­ä¼šé»˜è®¤è‡ªå¸¦ä¸€ä¸ª tmp.mountæœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡é»˜è®¤æ˜¯å…³é—­çš„ï¼ˆé»˜è®¤æ˜¯æ€»å†…å­˜çš„ä¸€åŠï¼‰
# è¿™ä¸ªæœåŠ¡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆæŠŠå†…å­˜å½“ç£ç›˜ä½¿ï¼Œåœ¨ä¸Šé¢å¯ä»¥åˆ›å»ºæ–‡ä»¶ï¼‰
systemctl start tmp.mount

# ç„¶åæˆ‘ä»¬é€šè¿‡ df -h /tmp å¯ä»¥çœ‹åˆ°
Filesystem      Size  Used Avail Use% Mounted on
tmpfs           126G  111G   16G  88% /tmp

è¿™é‡ŒæŒ‚è½½äº†/tmp ç›®å½•ï¼Œæ–‡ä»¶ç³»ç»Ÿæ˜¯ tmpfs

# ç„¶åæˆ‘ä»¬è¿›å…¥ /tmpç›®å½•
# æ¨¡æ‹Ÿæ–‡ä»¶åˆ›å»º
dd if=/dev/zero of=test.txt bs=G count=100

# ç„¶åæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼Œç„¶å free -g å°±å¯ä»¥çœ‹åˆ°å†…å­˜æˆåŠŸæ¶ˆè€—äº†100GğŸ˜‚
```

è¿™ç§åœºæ™¯ä¹Ÿæ˜¯æˆ‘ä¹‹å‰åœ¨æ’æŸ¥é—®é¢˜çš„æ—¶å€™é‡åˆ°çš„ï¼Œå¤§å®¶æœ‰å…¶ä»–ç±»ä¼¼åœºæ™¯ä¹Ÿå¯ä»¥è¿›è¡Œè¡¥å……

## ç£ç›˜é—®é¢˜

çº¿ä¸Šçš„ç£ç›˜é—®é¢˜ï¼Œé™¤äº†ç£ç›˜æ•…éšœ(åå—ã€æ–‡ä»¶ç³»ç»ŸæŸåã€RAID ç­‰)ä¹‹å¤–ï¼Œå¸¸è§çš„æ¯”è¾ƒå¤šçš„é—®é¢˜å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šç£ç›˜ç©ºé—´ä¸è¶³å’Œ IO æ€§èƒ½é—®é¢˜

### ç£ç›˜ç©ºé—´ä¸è¶³
å¯¹äºè¿™ç±»é—®é¢˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ¬èº«å¯èƒ½å°±æ˜¯æ•°æ®æ–‡ä»¶ã€æ—¥å¿—ä¿¡æ¯ç­‰è¿‡å¤šå¯¼è‡´çš„**çœŸå®å ç”¨**ï¼Œè¿˜æœ‰ä¸€ç±»æ˜¯æ–‡ä»¶å¥æŸ„æ³„éœ²å¯¼è‡´ç£ç›˜æ²¡æœ‰é‡Šæ”¾ä»è€Œå æ®äº†å¤šä½™çš„ç£ç›˜ç©ºé—´

å¯¹äºè¿™ç±»é—®é¢˜æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡ä»¥ä¸‹æ‰‹æ®µè¿›è¡Œæ’æŸ¥ï¼Œå‡å¦‚è¯´æˆ‘ä»¬ç°åœ¨æ¥åˆ°å‘Šè­¦ è¯´æ ¹ç›®å½•çš„ç£ç›˜ç©ºé—´ä¸è¶³äº†

1. é€šè¿‡`df -h`å‘½ä»¤æŸ¥çœ‹ç£ç›˜åˆ†åŒºçš„ä½¿ç”¨æƒ…å†µã€‚
2. è¿›å…¥ `"/"` ç›®å½•ä¸‹ï¼Œå¯ä»¥å¯¹å¸¸ç”¨çš„ç›®å½•è¿›è¡Œ `du -sh`æ“ä½œï¼Œç„¶åè¿›è¡Œç®€å•çš„ç›¸åŠ 
   - å¦‚æœåŠ èµ·æ¥çš„ç£ç›˜ç©ºé—´ï¼Œå’Œåˆ†åŒºä½¿ç”¨çš„ç£ç›˜ç©ºé—´ç›¸å·®ä¸å¤šï¼Œé‚£å°±åŸºæœ¬ä¸Šè¯´æ˜ç£ç›˜ç©ºé—´æ˜¯è¢«çœŸå®å ç”¨çš„ï¼Œæ‰¾åˆ°å ç”¨é«˜çš„ç›®å½•ç»§ç»­é€šè¿‡`du -sh` ç›®å½•ï¼Œä¸æ–­é€’å½’ã€‚æˆ–è€…æƒ³å¿«é€Ÿæ‰¾åˆ°ç£ç›˜ä¸­è¶…è¿‡ 1G çš„æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡`find ç›®å½• -type f -size +1G` è¿™æ ·çš„æ–¹å¼ã€‚
     å¦‚æœæƒ³å¿«é€Ÿç»Ÿè®¡åˆ°æ‰€æœ‰å­ç›®å½•çš„ç£ç›˜ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è¿™æ ·çš„æ–¹å¼è¿›è¡Œæ“ä½œ
     ```
     du -ah / 2>/dev/null | grep -E '^([0-9]+([KMGT]?)|([0-9]+(\.[0-9]+)?[KMGT]))' | sort -rh | head -10
     ```
   - å¦‚æœåŠ èµ·æ¥çš„ç£ç›˜ç©ºé—´ï¼Œå’Œåˆ†åŒºä½¿ç”¨çš„ç£ç›˜ç©ºé—´ç›¸å·®çš„æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆå¯èƒ½å­˜åœ¨å¥æŸ„æ³„éœ²ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶æœ¬èº«è¢«åˆ æ‰ï¼Œä½†æ˜¯å¥æŸ„æ²¡æœ‰é‡Šæ”¾ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹æ–¹å¼:
    ```
    #åˆ—å‡ºè¿›æ‰“å¼€æ–‡ä»¶æœ€å¤šçš„ 10 ä¸ªè¿›ç¨‹ï¼›
    lsof +L1 | awk '{print $2}' | sort | uniq -c | sort -rn | head -n 10

    # æŸ¥çœ‹æŸä¸ªè¿›ç¨‹çš„å ç”¨
    lsof -p $pid (æŸ¥çœ‹æ˜¯å¦å­˜åœ¨å·²ç»åˆ é™¤çš„æ–‡ä»¶å¥æŸ„æ²¡æœ‰é‡Šæ”¾ï¼Œå¯ä»¥é€šè¿‡ grep deleted è¿‡æ»¤)

    # æˆ–è€… ls /proc/$pid/fd è¿›è¡ŒæŸ¥çœ‹
    ```
### ç£ç›˜IOæ€§èƒ½é—®é¢˜

æˆ‘ä»¬å¯ä»¥é€šè¿‡ iostat çœ‹ä¸‹ç£ç›˜æ•´ä½“çš„è¯»å†™æƒ…å†µ:

{% image /images/iostat.png iostat fancybox:true %}

å…³äº iostat çš„é‡‡é›†ï¼Œå»ºè®®å¤šé‡‡é›†å‡ æ¬¡è§‚å¯Ÿï¼Œæ¯”å¦‚ `iostat -x 2`,æ¯ 2s æ£€æŸ¥ä¸€æ¬¡ï¼Œ ä¸€ç›´è¾“å‡ºï¼Œå½“ä¸éœ€è¦çš„æ—¶å€™ ctrl c æ‰

è¾“å‡ºçš„æŒ‡æ ‡æ¯ä¸€é¡¹è¯¦ç»†çš„ä»‹ç»å¦‚ä¸‹ï¼ˆä¹Ÿå¯ä»¥å‚è€ƒ man iostatï¼‰ï¼š
1. CPU ä½¿ç”¨æƒ…å†µ

| Metric    | Description                               |
|-----------|-------------------------------------------|
| %user     | ç”¨æˆ·æ¨¡å¼ä¸‹æ¶ˆè€—çš„ CPU æ—¶é—´ç™¾åˆ†æ¯”            |
| %nice     | è°ƒæ•´ä¼˜å…ˆçº§çš„ç”¨æˆ·æ¨¡å¼ä¸‹çš„ CPU æ—¶é—´ç™¾åˆ†æ¯”    |
| %system   | å†…æ ¸æ¨¡å¼ä¸‹æ¶ˆè€—çš„ CPU æ—¶é—´ç™¾åˆ†æ¯”            |
| %iowait   | CPU ç­‰å¾… I/O æ“ä½œå®Œæˆçš„æ—¶é—´ç™¾åˆ†æ¯”          |
| %steal    | ç­‰å¾…è™šæ‹Ÿ CPU è¢«å®é™… CPU æœåŠ¡çš„æ—¶é—´ç™¾åˆ†æ¯”   |
| %idle     | CPU ç©ºé—²æ—¶é—´ç™¾åˆ†æ¯”                        |

2. è®¾å¤‡ I/O ä½¿ç”¨æƒ…å†µ

| Metric        | Description                           |
|---------------|---------------------------------------|
| Device        | è®¾å¤‡åç§°                               |
| tps           | æ¯ç§’ä¼ è¾“æ•°ï¼ˆI/O è¯·æ±‚æ•°ï¼‰               |
| kB_read/s     | æ¯ç§’è¯»å–çš„ kB æ•°                       |
| kB_wrtn/s     | æ¯ç§’å†™å…¥çš„ kB æ•°                       |
| kB_read       | è¯»å–çš„ kB æ€»æ•°                        |
| kB_wrtn       | å†™å…¥çš„ kB æ€»æ•°                        |
| rrqm/s        | æ¯ç§’è¿›è¡Œçš„åˆå¹¶è¯»è¯·æ±‚æ•°                 |
| wrqm/s        | æ¯ç§’è¿›è¡Œçš„åˆå¹¶å†™è¯·æ±‚æ•°                 |
| r/s           | æ¯ç§’å®Œæˆçš„è¯»è¯·æ±‚æ•°                     |
| w/s           | æ¯ç§’å®Œæˆçš„å†™è¯·æ±‚æ•°                     |
| rMB/s         | æ¯ç§’è¯»å–çš„ MB æ•°                       |
| wMB/s         | æ¯ç§’å†™å…¥çš„ MB æ•°                       |
| avgrq-sz      | å¹³å‡æ¯æ¬¡ I/O è¯·æ±‚çš„æ•°æ®å¤§å°            |
| avgqu-sz      | å¹³å‡ I/O é˜Ÿåˆ—é•¿åº¦                      |
| await         | å¹³å‡æ¯æ¬¡ I/O æ“ä½œçš„ç­‰å¾…æ—¶é—´            |
| svctm         | å¹³å‡æ¯æ¬¡ I/O æ“ä½œçš„æœåŠ¡æ—¶é—´            |
| %util         | è®¾å¤‡ I/O æ´»åŠ¨æ—¶é—´ç™¾åˆ†æ¯”ï¼ˆè¡¨ç¤ºè®¾å¤‡å¿™ç¢Œåº¦ï¼‰|

é€šè¿‡è¿™ä¸ªæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°ç£ç›˜çš„æ•´ä½“æƒ…å†µã€‚éœ€è¦æ³¨æ„çš„æ˜¯ %util åˆ° 100% ä¹‹åï¼Œä¸ä¸€å®šä»£è¡¨ç£ç›˜å‡ºç°äº†ç“¶é¢ˆï¼Œè¿˜éœ€è¦ç»“åˆå…¶ä»–æŒ‡æ ‡å…±åŒè¿›è¡Œåˆ¤æ–­ï¼Œæ¯”å¦‚æœ‰ä¸€å¼  nvme çš„ç›˜ï¼ŒæŒç»­çš„è¯»å†™ï¼Œè¿™ç§æƒ…å†µä¸‹æœ‰ä¸æ–­åœ° io æ“ä½œï¼Œ util çš„æŒ‡æ ‡ä¼šæ˜¾ç¤ºä¸º 100%ï¼Œä½†æ˜¯å¦‚æœç£ç›˜çš„è¯»å†™è¿˜æ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„èŒƒå›´å¹¶ä¸” avgqu-sz æŒ‡æ ‡å§‹ç»ˆä¸º 0ï¼ˆæ²¡æœ‰ io é˜»å¡ï¼‰ï¼Œé‚£å°±è¯´æ˜ç£ç›˜å®Œå…¨æ‰¿è½½å½“å‰çš„ç”¨é‡ï¼Œæ‰€ä»¥æ— éœ€å…³å¿ƒã€‚

å½“æˆ‘ä»¬æƒ³æŸ¥çœ‹è¿›ç¨‹å ç”¨çš„ io æƒ…å†µæ—¶ï¼Œå¯ä»¥é€šè¿‡ `iotop`å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼Œå¦‚ä¸‹:

{% image /images/iotop.png iotop fancybox:true %}

ç»“åˆä¸Šæ–‡è®²çš„ä¸€äº›å †æ ˆåˆ†æå·¥å…·ï¼Œæ¨æµ‹åˆ°è¿›ç¨‹å…·ä½“åœ¨åšé‚£äº›æ“ä½œç„¶åé’ˆå¯¹æ€§è¿›è¡Œå¤„ç†ã€‚
